<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®å†Š (Travel Log)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #fdfcf8; --bg-card: #ffffff;
            --theme-main: #8b5e3c; --theme-light: #f0e6dd; --theme-accent: #b08d73;
            --text-main: #4a4036; --text-sub: #968c83;
            --danger: #d68c8c; --link-blue: #7ca5b8;
        }
        body { background-color: var(--bg-body); font-family: 'Noto Sans TC', sans-serif; color: var(--text-main); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; transition: background-color 0.5s ease, color 0.3s ease; }
        .font-en { font-family: 'Montserrat', sans-serif; }
        
        #google-map { width: 100%; height: 300px; border-radius: 12px; filter: sepia(10%) contrast(95%); border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; z-index: 1; }
        
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: var(--theme-light); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--theme-accent); border-radius: 4px; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        button, input, select, textarea { outline: none; -webkit-tap-highlight-color: transparent; }
        .time-select { appearance: none; background-color: transparent; text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 600; color: var(--text-main); border-radius: 4px; padding: 0; cursor: pointer; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-card); opacity: 0.95; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-spinner { border: 4px solid var(--theme-light); border-top: 4px solid var(--theme-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--bg-card); padding: 20px; border-radius: 16px; width: 100%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid var(--theme-light); }
        
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid var(--theme-light); transition: transform 0.2s; }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.2); }
        
        .day-tab { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-width: 2px; }
        .day-tab.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .color-picker-dot { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; transition: transform 0.1s; }

        .custom-checkbox { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--theme-light); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background-color: transparent; }
        .custom-checkbox:checked::after { content: 'âœ”'; color: #666; font-size: 14px; font-weight: bold; }

        .analysis-select { font-family: 'Montserrat', sans-serif !important; font-weight: 700; font-size: 10px; background-color: rgba(240, 230, 221, 0.3); border-radius: 0.5rem; padding: 0.25rem 0.5rem; outline: none; border: 1px solid var(--theme-light); color: var(--text-main); cursor: pointer; }
        .packing-member-select { @apply text-[10px] font-bold bg-[var(--theme-light)]/30 rounded-lg px-2 py-1 outline-none border border-[var(--theme-light)] text-[var(--text-main)] cursor-pointer; }

        .section-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem 0.25rem; margin-bottom: 0.5rem; cursor: pointer; user-select: none; }
        .section-title { font-family: 'Montserrat', sans-serif !important; font-weight: 700; font-size: 0.75rem; color: var(--text-sub); letter-spacing: 0.1em; text-transform: uppercase; }

        .settle-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; border-bottom: 1px dashed var(--theme-light); }
        .settle-payer, .settle-receiver { flex: 1; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .settle-label { width: 40px; text-align: center; color: var(--danger); font-weight: bold; }
        .settle-amount { text-align: right; font-weight: bold; color: var(--theme-main); }

        textarea { resize: vertical; overflow: hidden; }
    </style>
</head>
<body>

<div id="app" :style="currentThemeStyles" class="max-w-md mx-auto bg-[var(--bg-body)] min-h-screen shadow-2xl relative pb-12 border-x border-[var(--theme-light)] overflow-hidden font-sans text-[var(--text-main)] transition-colors duration-500">
    
    <div v-if="isLoading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="mt-2 text-xs font-bold text-[var(--theme-main)]">è®€å–ä¸­...</div>
        <button @click="isLoading = false" class="mt-4 text-[10px] text-[var(--text-sub)] underline">å¦‚æœå¡ä½è«‹é»æ­¤</button>
    </div>

    <!-- ç…§ç‰‡å…¨è¢å¹•é è¦½ -->
    <div v-if="previewPhotoUrl" class="modal-overlay" @click="previewPhotoUrl = null" style="z-index: 200;">
        <div class="max-w-full max-h-full p-4">
            <img :src="previewPhotoUrl" class="rounded-xl shadow-2xl max-h-[80vh] object-contain mx-auto border-4 border-white">
        </div>
    </div>

    <!-- è³¼ç‰©é …ç›®ç·¨è¼¯ Modal -->
    <div v-if="showWishEditModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4">âœï¸ ç·¨è¼¯æ¸…å–®é …ç›®</h3>
            <div class="space-y-3">
                <input v-model="editWishTemp.name" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                <select v-model="editWishTemp.day" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                    <option value="all">ä¸æŒ‡å®šæ—¥æœŸ</option>
                    <option v-for="(day, idx) in days" :key="idx" :value="idx">Day {{ idx + 1 }}</option>
                </select>
                <input v-model="editWishTemp.note" placeholder="å‚™è¨»" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                <input v-model="editWishTemp.url" placeholder="é€£çµ URL" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                <input v-model="editWishTemp.address" placeholder="åœ°å€" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="showWishEditModal = false" class="flex-1 py-2 text-xs text-[var(--text-sub)] rounded-lg">å–æ¶ˆ</button>
                <button @click="saveWishItemEdit" class="flex-1 py-2 text-xs text-white bg-[var(--theme-main)] rounded-lg font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹è¨­å®š Modal -->
    <div v-if="showSettingsModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4">âš™ï¸ è¡Œç¨‹è¨­å®š</h3>
            <input v-model="editTemp.name" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none mb-4">
            <div class="flex justify-center gap-4 mb-6">
                <div v-for="(theme, key) in themePresets" :key="key" class="color-dot" :class="{ active: editTemp.theme === key }" :style="{ backgroundColor: theme['--theme-main'] }" @click="previewTheme(key)"></div>
            </div>
            <div class="flex gap-2">
                <button @click="showSettingsModal = false" class="flex-1 py-2 text-xs text-[var(--text-sub)] rounded-lg">å–æ¶ˆ</button>
                <button @click="saveTripSettings" class="flex-1 py-2 text-xs text-white bg-[var(--theme-main)] rounded-lg font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¤©æ•¸ç®¡ç† Modal -->
    <div v-if="showDayManager" class="modal-overlay">
        <div class="modal-card !max-w-[340px]">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4 font-en tracking-widest text-sm">MANAGE DAYS</h3>
            <div class="max-h-[350px] overflow-y-auto space-y-2 custom-scroll pr-2">
                <div v-for="(day, index) in days" :key="index" class="flex items-center gap-2 bg-[var(--bg-body)] p-2 rounded-xl border border-[var(--theme-light)]">
                    <div class="text-[10px] font-bold w-12 text-[var(--text-sub)]">Day {{ index+1 }}</div>
                    <div class="flex gap-1 flex-1 overflow-x-auto scrollbar-hide">
                        <div v-for="c in dayColorPresets" :key="c" @click="day.color = c; saveData()" 
                             :style="{ backgroundColor: c }" 
                             :class="['color-picker-dot', (day.color === c || (!day.color && c === '#8b5e3c')) ? 'ring-2 ring-offset-1 ring-gray-400 scale-110' : 'opacity-60']">
                        </div>
                    </div>
                    <div class="flex items-center bg-[var(--theme-light)]/30 rounded-lg px-1">
                        <button @click="moveDay(index, -1)" :disabled="index === 0" class="p-1.5 text-xs text-[var(--theme-main)] disabled:opacity-20">â–²</button>
                        <button @click="moveDay(index, 1)" :disabled="index === days.length - 1" class="p-1.5 text-xs text-[var(--theme-main)] disabled:opacity-20">â–¼</button>
                    </div>
                </div>
            </div>
            <button @click="showDayManager = false" class="w-full mt-4 py-2 bg-[var(--theme-main)] text-white rounded-lg font-bold text-xs">å®Œæˆ</button>
        </div>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <transition name="slide">
        <div v-if="showSidebar" class="fixed inset-0 z-50 flex">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showSidebar = false"></div>
            <div class="relative bg-[var(--bg-body)] w-72 h-full shadow-2xl flex flex-col border-r border-[var(--theme-light)]">
                <div class="p-5 border-b border-[var(--theme-light)]">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-[var(--theme-main)] tracking-widest">æ—…ç¨‹æ›¸æ«ƒ</h2>
                        <button @click="showSidebar = false" class="text-[var(--text-sub)]">âœ•</button>
                    </div>
                    <div class="text-[10px] text-[var(--text-sub)] font-normal mt-1 opacity-70 italic">é¦–é ç‚ºæ“ºæ”¾æœ€ä¸Šå±¤æ—…éŠæ›¸</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                    <div v-for="(trip, index) in sortedTrips" :key="trip.id" @click="openTrip(trip.id)" 
                         :class="currentTripId === trip.id ? 'border-[var(--theme-main)] bg-[var(--bg-card)] shadow-md' : 'border-transparent hover:bg-[var(--bg-card)]'" 
                         class="flex items-stretch rounded-xl border bg-[var(--bg-card)] overflow-hidden transition cursor-pointer mb-2 relative p-3">
                        <div class="flex-1 min-w-0 pb-6">
                            <div class="font-bold text-[var(--text-main)] text-sm truncate">{{ trip.tripName || 'æœªå‘½åè¡Œç¨‹' }}</div>
                            <div class="text-[10px] text-[var(--text-sub)] mt-1 font-en">{{ trip.startDate || 'ç„¡æ—¥æœŸ' }}</div>
                        </div>
                        <div class="absolute bottom-2 right-2 flex items-center gap-2">
                             <button @click.stop="openTripSettings(trip.id)" class="text-[10px] p-1 bg-white/80 rounded">âš™ï¸</button>
                             <button @click.stop="confirmDeleteTrip(trip.id)" class="text-[var(--danger)] p-1 bg-white/80 rounded">âœ•</button>
                        </div>
                        <div class="w-4 bg-[var(--theme-light)]/30 border-l border-[var(--theme-light)] flex flex-col justify-center items-center gap-1">
                            <button @click.stop="moveTripBook(index, -1)" class="text-[10px]" :disabled="index === 0">â–²</button>
                            <button @click.stop="moveTripBook(index, 1)" class="text-[10px]" :disabled="index === sortedTrips.length - 1">â–¼</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-[var(--theme-light)]">
                    <button @click="createNewTrip" class="w-full bg-[var(--theme-main)] text-white py-3 rounded-xl font-bold shadow-md text-sm">+ å»ºç«‹æ–°æ—…ç¨‹</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Header -->
    <div class="sticky top-0 z-30 bg-[var(--bg-body)]/95 backdrop-blur-sm border-b border-[var(--theme-light)] p-4 transition-colors">
        <button @click="showSidebar = true" class="absolute left-4 top-5 text-[var(--theme-main)]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></button>
        <div class="flex items-center justify-center mb-4 pl-8 pr-8">
            <input v-model="tripName" @change="saveData" class="text-center w-full text-xl font-bold text-[var(--theme-main)] bg-transparent border-b-2 border-transparent focus:border-[var(--theme-accent)] transition py-1 tracking-widest" placeholder="æ—…ã®è¨ˆç•«...">
        </div>
        <div class="flex justify-center mb-3">
            <div class="bg-[var(--theme-light)]/30 p-1.5 rounded-full flex w-full max-w-[360px] shadow-inner gap-1 overflow-x-auto scrollbar-hide">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="currentTab === tab.id ? 'bg-[var(--bg-card)] text-[var(--theme-main)] shadow-sm font-bold' : 'text-[var(--text-sub)]'" class="flex-1 py-1.5 px-2 rounded-full text-xs transition-all whitespace-nowrap">{{ tab.name }}</button>
            </div>
        </div>
        <div v-if="currentTab === 'schedule'" class="flex flex-col gap-2 mt-2 px-1">
            <div class="flex items-center justify-end px-1 gap-2">
                <label class="text-[10px] text-[var(--text-sub)]">å‡ºç™¼æ—¥:</label>
                <input type="date" v-model="startDate" @change="saveData" class="text-[10px] bg-transparent text-[var(--theme-main)] font-en outline-none border-b border-[var(--theme-light)]">
            </div>
            <div class="flex items-center gap-2">
                <div class="flex-1 min-w-0 overflow-x-auto whitespace-nowrap hide-scrollbar flex gap-2 pb-2">
                    <div v-for="(day, index) in days" :key="index" @click="changeDay(index)">
                        <div :style="{ backgroundColor: currentDayIndex === index ? (day.color || 'var(--theme-main)') : 'var(--bg-card)', color: currentDayIndex === index ? '#fff' : (day.color || 'var(--text-sub)'), borderColor: currentDayIndex === index ? 'transparent' : (day.color || 'var(--theme-light)') }" 
                             :class="['day-tab px-3 py-1.5 rounded-lg flex flex-col items-center justify-center min-w-[70px] border', currentDayIndex === index ? 'active' : '']">
                            <span class="text-xs font-en font-bold">Day {{ index + 1 }}</span>
                            <span class="text-[9px] font-en opacity-80 mt-0.5">{{ getDateLabel(index) }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-1 mb-2">
                    <button @click="showDayManager = true" class="shrink-0 w-8 h-8 flex items-center justify-center bg-[var(--theme-light)]/50 text-[var(--theme-main)] rounded-lg text-sm">âš™ï¸</button>
                    <button @click="addDay" class="shrink-0 w-8 h-8 flex items-center justify-center border-2 border-dashed border-[var(--theme-accent)] text-[var(--theme-main)] rounded-lg text-sm">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…§å®¹å€ -->
    <div class="p-5 min-h-[500px]">
        
        <!-- PAGE 1: è¡Œç¨‹è¡¨ -->
        <div v-if="currentTab === 'schedule'" class="space-y-6 animate-fade">
            <div v-if="weatherData" class="flex items-center justify-center gap-2 text-[var(--theme-main)] text-sm font-bold bg-[var(--theme-light)]/50 py-0.5 rounded-md">
                <span class="text-xl">{{ weatherData.icon }}</span><span>{{ weatherData.temp }}Â°C</span><span class="text-[var(--text-sub)] font-normal text-xs">{{ weatherData.desc }}</span>
            </div>
            <div id="google-map"></div>
            <div class="flex justify-between items-end border-b border-[var(--theme-light)] pb-2">
                <h2 class="text-sm font-bold">Day {{ currentDayIndex + 1 }} <span class="text-xs font-normal ml-1">{{ getDateLabel(currentDayIndex) }}</span></h2>
                <button @click="deleteDay" class="text-[10px] text-[var(--text-sub)]">DELETE DAY</button>
            </div>
            <div v-if="days[currentDayIndex]" class="space-y-2">
                <template v-for="(item, index) in days[currentDayIndex].activities" :key="index">
                    <div class="flex items-stretch gap-0 group relative bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] overflow-hidden p-3">
                        <div class="flex-1 flex items-start gap-3 min-w-0">
                            <div class="w-16 flex-shrink-0">
                                <input v-model="item.time" type="time" @change="saveData" class="text-sm font-bold bg-transparent outline-none w-full text-[var(--theme-main)]">
                                <select v-model="item.type" @change="saveData" class="text-[10px] bg-transparent opacity-60 w-full mt-1">
                                    <option value="sightseeing">ğŸ“· æ™¯é»</option><option value="transport">ğŸš… äº¤é€š</option><option value="food">ğŸ´ ç¾é£Ÿ</option><option value="accommodation">ğŸ¨ ä½å®¿</option>
                                </select>
                            </div>
                            <div class="flex-1 min-w-0">
                                <input v-model="item.place" @change="saveData" @focus="initAutocomplete(index, $event)" placeholder="åœ°é»åç¨±" class="w-full font-bold bg-transparent outline-none">
                                <textarea v-model="item.note" @change="saveData" rows="1" @input="autoGrow($event.target)" placeholder="å‚™è¨»..." class="w-full text-xs text-[var(--text-sub)] bg-transparent outline-none resize-none"></textarea>
                            </div>
                            <button @click="deleteActivity(index)" class="text-[var(--theme-light)] hover:text-[var(--danger)]">âœ•</button>
                        </div>
                    </div>
                    <!-- æ¥é§äº¤é€šæ–‡å­—æ¬„ä½ -->
                    <div v-if="index < days[currentDayIndex].activities.length - 1" class="ml-10 border-l-2 border-dotted border-[var(--theme-light)] pl-4 py-2">
                        <button v-if="!item.transportToNext && !item.showTransportInput" @click="item.showTransportInput = true" class="text-[9px] font-bold text-[var(--theme-accent)] opacity-40 hover:opacity-100">+ æ¥é§å‚™è¨»</button>
                        <div v-else class="flex gap-2">
                            <textarea v-model="item.transportToNext" @change="saveData" placeholder="è¼¸å…¥äº¤é€šè³‡è¨Š..." class="flex-1 text-[10px] bg-transparent outline-none italic text-[var(--theme-accent)] resize-none"></textarea>
                            <button @click="item.transportToNext = ''; item.showTransportInput = false; saveData()" class="text-[10px] text-[var(--text-sub)]">âœ•</button>
                        </div>
                    </div>
                </template>
            </div>
            <button @click="addActivity" class="w-full py-3 border border-dashed border-[var(--theme-accent)] text-[var(--theme-accent)] rounded-xl text-xs">+ ADD ITEM</button>
            <div v-if="days[currentDayIndex]" class="mt-4 p-3 bg-[var(--theme-light)]/20 rounded-xl">
                <div class="text-[10px] font-bold text-[var(--text-sub)] mb-1">DAILY NOTE</div>
                <textarea v-model="days[currentDayIndex].dailyNote" @change="saveData" rows="2" class="w-full text-xs bg-transparent outline-none" placeholder="ä»Šæ—¥ç¸½çµ..."></textarea>
            </div>
        </div>

        <!-- PAGE 2: æ¶ˆè²»ç´€éŒ„ -->
        <div v-if="currentTab === 'expenses'" class="space-y-6 animate-fade">
            <div @click="showRates = !showRates" class="section-header"><h3 class="section-title">EXCHANGE RATES</h3><span class="section-arrow">â–¼</span></div>
            <div v-show="showRates" class="bg-[var(--bg-card)] rounded-xl border p-4 grid grid-cols-3 gap-3">
                <div v-for="(v, k) in rates" :key="k" class="text-center"><label class="text-[10px] block font-bold">{{k}}</label><input v-model.number="rates[k]" @change="saveData" class="w-full text-center border-b text-sm"></div>
            </div>

            <div @click="showAnalysis = !showAnalysis" class="section-header"><h3 class="section-title">ANALYSIS</h3><span class="section-arrow">â–¼</span></div>
            <div v-show="showAnalysis" class="bg-[var(--bg-card)] p-5 rounded-xl border shadow-sm">
                <div class="flex justify-between mb-3"><select v-model="analysisFilter" class="analysis-select"><option value="all">All</option><option v-for="m in members" :value="m">{{m}}</option></select><select v-model="analysisCurrency" class="analysis-select"><option value="TWD">TWD</option><option value="JPY">JPY</option></select></div>
                <div class="h-32 relative"><canvas id="expenseChart"></canvas></div>
            </div>

            <div @click="showSettlement = !showSettlement" class="section-header"><h3 class="section-title">SETTLEMENT</h3><span class="section-arrow">â–¼</span></div>
            <div v-show="showSettlement" class="bg-[var(--theme-light)]/30 p-4 rounded-xl border">
                <div v-for="(trans, idx) in settlementPlan" :key="idx" class="settle-row py-2">
                    <div class="settle-payer text-xs">{{ trans.from }}</div><div class="settle-label">éœ€çµ¦</div><div class="settle-receiver text-xs">{{ trans.to }}</div><div class="settle-amount text-xs">{{ trans.amount }} <span class="text-[8px]">{{ displayCurrency }}</span></div>
                </div>
                <div v-if="settlementPlan.length === 0" class="text-center text-[10px] py-2">ç„¡å¾…çµæ¸…é …ç›®</div>
            </div>

            <div ref="expenseForm" class="bg-[var(--bg-card)] p-4 rounded-xl border space-y-4 shadow-sm">
                <div class="flex gap-2"><input v-model="newExpense.title" placeholder="é …ç›®" class="flex-1 font-bold border-b bg-transparent outline-none text-sm"><select v-model="newExpense.category" class="text-xs border rounded"><option value="food">ğŸ´ ç¾é£Ÿ</option><option value="transport">ğŸš… äº¤é€š</option><option value="other">ğŸ“¦ å…¶ä»–</option></select></div>
                <input v-model="newExpense.note" placeholder="å‚™è¨» (é¸å¡«)" class="w-full text-xs border-b bg-transparent outline-none">
                <div class="flex gap-2"><input type="number" v-model.number="newExpense.amount" :readonly="splitMode === 'custom'" class="flex-1 text-sm bg-[var(--bg-body)] rounded p-2" placeholder="é‡‘é¡"><select v-model="newExpense.currency" class="text-xs border rounded"><option value="TWD">TWD</option><option value="JPY">JPY</option></select></div>
                <div class="flex items-center gap-2"><span class="text-[10px]">æ—¥æœŸ:</span><input type="date" v-model="newExpense.date" class="text-xs border-b bg-transparent"><span class="text-[10px] ml-auto">ä»˜æ¬¾äºº:</span><select v-model="newExpense.payer" class="text-xs border rounded"><option v-for="m in members" :value="m">{{m}}</option></select></div>
                <div class="flex items-center gap-2">
                    <button @click="$refs.expensePhotoInput.click()" class="p-2 bg-[var(--theme-light)] rounded-lg">ğŸ“·</button>
                    <input type="file" ref="expensePhotoInput" @change="handlePhotoUpload" accept="image/*" class="hidden">
                    <img v-if="newExpense.photo" :src="newExpense.photo" class="w-10 h-10 object-cover rounded" @click="previewPhotoUrl = newExpense.photo">
                </div>
                <div class="flex gap-3 text-[10px]"><button @click="changeSplitMode('equal')" :class="splitMode === 'equal' ? 'font-bold underline' : 'opacity-50'">å¹³å‡åˆ†æ“”</button><button @click="changeSplitMode('custom')" :class="splitMode === 'custom' ? 'font-bold underline' : 'opacity-50'">è‡ªè¨‚é‡‘é¡</button></div>
                <div v-if="splitMode === 'equal'" class="flex flex-wrap gap-2"><button v-for="m in members" @click="toggleInvolved(m)" :class="newExpense.involved.includes(m) ? 'bg-[var(--theme-main)] text-white' : 'border opacity-50'" class="text-[10px] px-3 py-1 rounded-full transition">{{m}}</button></div>
                <div v-if="splitMode === 'custom'" class="space-y-2"><div v-for="m in members" :key="m" class="flex items-center justify-between"><span class="text-[10px]">{{m}}</span><input type="number" v-model.number="customSplitAmounts[m]" @input="updateTotalFromCustom" class="w-24 text-right border-b text-xs bg-transparent"></div></div>
                <div class="flex gap-2">
                    <button v-if="editingExpenseIndex !== null" @click="cancelEditExpense" class="flex-1 py-2 text-xs bg-gray-200 rounded">Cancel</button>
                    <button @click="addExpense" class="flex-[2] py-2 text-xs bg-[var(--theme-main)] text-white rounded font-bold uppercase">{{ editingExpenseIndex !== null ? 'Save Changes' : 'Add Record' }}</button>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(group, dateKey) in groupedExpenses" :key="dateKey">
                    <div class="text-[10px] font-bold text-[var(--text-sub)] border-b mb-2 pb-1">{{ dateKey }}</div>
                    <div v-for="item in group.items" :key="item.originalIndex" class="bg-[var(--bg-card)] p-3 rounded-xl border flex gap-3 relative mb-2 shadow-sm">
                        <div class="text-xl shrink-0">{{ getCategoryIcon(item.data.category) }}</div>
                        <div class="min-w-0 flex-1">
                            <div class="overflow-x-auto whitespace-nowrap hide-scrollbar cursor-grab active:cursor-grabbing"><span class="text-sm font-bold inline-block">{{ item.data.title }}</span></div>
                            <div v-if="item.data.note" class="overflow-x-auto whitespace-nowrap hide-scrollbar text-[9px] text-[var(--text-sub)] italic"><div class="inline-block">{{ item.data.note }}</div></div>
                            <div class="text-[10px] opacity-70 mt-1">{{ item.data.payer }} ä»˜ Â· {{ item.data.currency }} {{ item.data.amount }}</div>
                        </div>
                        <div class="flex flex-col items-end shrink-0 border-l pl-3">
                            <div class="flex gap-2 mb-1"><button @click.stop="editExpenseRecord(item.originalIndex)" class="text-[var(--text-sub)] hover:text-[var(--theme-main)]">âœ</button><button @click.stop="deleteExpense(item.originalIndex)" class="text-[var(--text-sub)] hover:text-[var(--danger)]">âœ•</button></div>
                            <div class="text-right"><div class="font-bold text-sm">{{ item.data.currency }} {{ item.data.amount }}</div><div v-if="item.data.currency !== 'TWD'" class="text-[9px] text-[var(--theme-accent)]">â‰ˆ {{ Math.round(item.data.amount * (rates[item.data.currency] || 1)) }} TWD</div><img v-if="item.data.photo" :src="item.data.photo" class="w-6 h-6 object-cover rounded border mt-1" @click.stop="previewPhotoUrl = item.data.photo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <div @click="showChangelog = !showChangelog" class="section-header border-t pt-4"><h3 class="section-title">RECENT CHANGES</h3><span class="section-arrow">â–¼</span></div>
                <div v-show="showChangelog" class="bg-[var(--theme-light)]/20 p-3 rounded-lg space-y-1 animate-fade">
                    <div v-for="(log, idx) in changelog" :key="idx" class="text-[9px] border-b border-dashed pb-1 flex justify-between"><span class="text-[var(--text-sub)] font-en">{{ log.time }}</span><span class="font-bold">[{{ log.action }}] {{ log.title }}</span></div>
                </div>
            </div>
        </div>

        <!-- PAGE 3: è³¼ç‰©ç¾é£Ÿ -->
        <div v-if="currentTab === 'wishlist'" class="space-y-6 animate-fade">
            <div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button @click="wishlistFilterDay = 'all'" :class="wishlistFilterDay === 'all' ? 'bg-[var(--theme-main)] text-white' : 'bg-[var(--bg-card)] border'" class="px-4 py-1.5 rounded-full text-[10px] font-bold whitespace-nowrap">å…¨éƒ¨</button>
                <button v-for="(day, idx) in days" :key="idx" @click="wishlistFilterDay = idx" :class="wishlistFilterDay === idx ? 'bg-[var(--theme-main)] text-white shadow-sm' : 'bg-[var(--bg-card)] border'" class="px-4 py-1.5 rounded-full text-[10px] font-bold whitespace-nowrap">Day {{ idx + 1 }}</button>
            </div>
            <div class="space-y-3">
                <div v-for="(item, idx) in filteredWishlist" :key="idx" class="bg-[var(--bg-card)] p-3 rounded-xl border relative">
                    <div class="flex items-start gap-3 pr-10">
                        <input type="checkbox" v-model="item.checked" @change="saveData" class="custom-checkbox mt-1">
                        <div class="flex-1 min-w-0" :class="{'opacity-40': item.checked}">
                            <div class="flex items-center gap-2"><span class="font-bold text-sm truncate">{{ item.name }}</span><span v-if="item.day !== 'all'" class="text-[8px] bg-gray-100 px-1 rounded">D{{ item.day + 1 }}</span></div>
                            <div v-if="item.note" class="text-xs text-[var(--text-sub)] truncate">{{ item.note }}</div>
                            <div v-if="item.url" @click="window.open(item.url, '_blank')" class="text-[9px] text-[var(--link-blue)] truncate cursor-pointer underline">{{ item.url }}</div>
                        </div>
                    </div>
                    <div class="absolute top-3 right-3 flex flex-col gap-2"><button @click="openWishEditModal(item.originalIndex)" class="text-[var(--text-sub)] text-xs">âœ</button></div>
                </div>
            </div>
            <div class="bg-[var(--bg-card)] p-4 rounded-xl border space-y-2 mt-4">
                <div class="flex justify-between items-center"><span class="text-xs font-bold">æ–°å¢è³¼ç‰©é …ç›®</span><select v-model="newWishItem.day" class="text-[10px] border rounded"><option value="all">ä¸æŒ‡å®šæ—¥æœŸ</option><option v-for="(day, idx) in days" :key="idx" :value="idx">Day {{ idx + 1 }}</option></select></div>
                <input v-model="newWishItem.name" placeholder="é …ç›®åç¨±" class="w-full border-b text-sm p-1 bg-transparent"><button @click="addWishItem" class="w-full py-2 bg-[var(--theme-main)] text-white rounded text-xs">ADD</button>
            </div>
        </div>

        <!-- PAGE 4: å¸¸ç”¨é€£çµ -->
        <div v-if="currentTab === 'links'" class="space-y-4 animate-fade">
            <h3 class="section-title">CLOUD & LINKS</h3>
            <div class="space-y-3">
                <div v-for="(link, idx) in externalLinks" :key="idx" class="bg-[var(--bg-card)] p-3 rounded-xl border flex justify-between items-center">
                    <div @click="window.open(link.url, '_blank')" class="flex-1 cursor-pointer"><div class="font-bold text-sm">{{ link.title }}</div><div class="text-[9px] opacity-60 truncate">{{ link.url }}</div></div>
                    <button @click="deleteLink(idx)" class="text-[var(--danger)] px-2">âœ•</button>
                </div>
            </div>
            <div class="bg-[var(--bg-card)] p-4 rounded-xl border space-y-2 mt-4">
                <input v-model="newLink.title" placeholder="æ¨™é¡Œ" class="w-full border-b text-sm p-1 bg-transparent">
                <input v-model="newLink.url" placeholder="ç¶²å€ (https://...)" class="w-full border-b text-sm p-1 bg-transparent">
                <button @click="addLink" class="w-full py-2 bg-[var(--theme-main)] text-white rounded text-xs">ADD LINK</button>
            </div>
        </div>

        <!-- PAGE 5: è¡Œææ¸…å–® -->
        <div v-if="currentTab === 'packing'" class="space-y-6 animate-fade">
            <div class="bg-[var(--bg-card)] p-4 rounded-xl border">
                 <div class="flex justify-between items-center mb-3"><h3 class="section-title">PACKING</h3><select v-model="currentPackingMember" class="packing-member-select"><option v-for="m in members" :key="m" :value="m">{{m}}</option></select></div>
                 <div class="flex justify-between items-end mb-1"><span class="text-[10px] font-bold">{{ currentPackingMember }} çš„é€²åº¦</span><span class="text-[10px] font-en font-bold text-[var(--theme-main)]">{{ packingProgress }}%</span></div>
                 <div class="h-2 w-full bg-[var(--theme-light)] rounded-full overflow-hidden"><div class="h-full bg-[var(--theme-accent)] transition-all" :style="{ width: packingProgress + '%' }"></div></div>
            </div>
            <div class="space-y-2">
                <div v-for="(item, idx) in currentPackingList" :key="idx" class="flex items-center gap-3 bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--theme-light)]"><input type="checkbox" v-model="item.checked" @change="saveData" class="custom-checkbox"><input v-model="item.name" @change="saveData" class="flex-1 bg-transparent outline-none text-sm" :class="{'opacity-50 line-through': item.checked}"><button @click="deletePackingItem(idx)" class="text-[var(--danger)]">âœ•</button></div>
                <div v-if="currentPackingList.length === 0" class="text-center py-10 border-2 border-dashed rounded-xl"><p class="text-xs opacity-50 mb-3">æ¸…å–®ç›®å‰æ˜¯ç©ºçš„</p><button @click="loadDefaultPackingItems" class="text-[10px] border px-3 py-1 rounded">è¼‰å…¥å»ºè­°é …ç›®</button></div>
            </div>
            <div class="flex gap-2"><input v-model="newPackingItem" @keyup.enter="addPackingItem" placeholder="æ–°å¢ç‰©å“..." class="flex-1 border p-2 rounded text-sm"><button @click="addPackingItem" class="bg-[var(--theme-main)] text-white px-4 rounded font-bold text-xs">ADD</button></div>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-[var(--bg-body)] border-t p-2 text-center text-[10px] text-[var(--text-sub)] tracking-widest">{{ statusMessage }}</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCv9tkLUA9T3lYlz6JLf_wuWFAZLR2nRHY&libraries=places"></script>

<script>
    const { createApp } = Vue;
    const firebaseConfig = { apiKey: "AIzaSyACnUlpKnoImSKhnmEDLAwKfuUOXAKijrU", authDomain: "mytrip-cf4ce.firebaseapp.com", databaseURL: "https://mytrip-cf4ce-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mytrip-cf4ce", storageBucket: "mytrip-cf4ce.firebasestorage.app", messagingSenderId: "336541146264", appId: "1:336541146264:web:484f98b025c151a1e244ed" };
    const hasFirebase = true; 
    let db = null;
    if (hasFirebase) { try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e) {} }

    createApp({
        data() {
            return {
                isLoading: true, showSidebar: false, currentTab: 'schedule', 
                tabs: [{id:'schedule', name:'è¡Œç¨‹è¡¨'}, {id:'expenses', name:'æ¶ˆè²»ç´€éŒ„'}, {id:'wishlist', name:'è³¼ç‰©ç¾é£Ÿ'}, {id:'links', name:'å¸¸ç”¨é€£çµ'}, {id:'packing', name:'è¡Œææ¸…å–®'}],
                tripName: '', statusMessage: 'Connecting...', currentDayIndex: 0, startDate: '',
                days: [{ activities: [], color: '' }], members: ['æˆ‘', 'æ—…ä¼´'], 
                rates: { TWD: 1, JPY: 0.22, USD: 32.5 }, displayCurrency: 'TWD', analysisCurrency: 'TWD', analysisFilter: 'all',
                expenses: [], editingExpenseIndex: null, splitMode: 'equal', customSplitAmounts: {},
                newExpense: { title: '', amount: 0, payer: 'æˆ‘', currency: 'TWD', involved: ['æˆ‘', 'æ—…ä¼´'], category: 'other', note: '', photo: null, date: new Date().toISOString().split('T')[0] },
                wishlist: [], newWishItem: { name: '', day: 'all' }, showWishEditModal: false, editWishTemp: {},
                externalLinks: [], newLink: { title: '', url: '' },
                packingList: {}, currentPackingMember: 'æˆ‘', newPackingItem: '',
                changelog: [], showChangelog: false, showAnalysis: true, showSettlement: true, showRates: false, showDayManager: false, 
                previewPhotoUrl: null, mapError: false, weatherData: null, hourOptions: Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0')),
                minuteOptions: ['00', '15', '30', '45'], dayColorPresets: ['#8b5e3c', '#d65d7a', '#4a7a8c', '#5e7e5e'],
                allTrips: {}, currentTripId: null, localOrder: [], showSettingsModal: false, editTemp: {}
            }
        },
        computed: {
            currentThemeStyles() { const t = this.allTrips[this.currentTripId]; return { '--theme-main': (t && t.theme === 'wood' ? '#8b5e3c' : '#8b5e3c') }; },
            sortedTrips() { if (!this.allTrips) return []; let trips = Object.keys(this.allTrips).map(id => ({ id, ...this.allTrips[id] })); trips.sort((a, b) => this.localOrder.indexOf(a.id) - this.localOrder.indexOf(b.id)); return trips; },
            groupedExpenses() { const groups = {}; this.expenses.forEach((exp, index) => { const k = exp.date || 'Other'; if (!groups[k]) groups[k] = { items: [] }; groups[k].items.push({ data: exp, originalIndex: index }); }); return groups; },
            categoryAnalysis() { 
                const map = {food: {label:'ç¾é£Ÿ', color:'#fca5a5'}, transport:{label:'äº¤é€š', color:'#93c5fd'}, other:{label:'å…¶ä»–', color:'#d1d5db'}};
                let stats = {}; Object.keys(map).forEach(k => stats[k] = 0);
                this.expenses.forEach(exp => {
                    const rate = this.rates[exp.currency] || 1;
                    const valInBase = exp.amount * rate;
                    stats[exp.category] = (stats[exp.category] || 0) + valInBase;
                });
                const targetRate = this.rates[this.analysisCurrency] || 1;
                return Object.keys(stats).map(k => ({ key:k, label:map[k].label, chartColor:map[k].color, amount: Math.round(stats[k]/targetRate) })).filter(i => i.amount > 0);
            },
            settlementPlan() {
                if (!this.members.length) return [];
                let balances = {}; this.members.forEach(m => balances[m] = 0);
                this.expenses.forEach(exp => {
                    const rate = this.rates[exp.currency] || 1;
                    const totalTWD = exp.amount * rate;
                    balances[exp.payer] += totalTWD;
                    if (exp.splitType === 'custom' && exp.customData) {
                        Object.entries(exp.customData).forEach(([m, amt]) => { if(balances.hasOwnProperty(m)) balances[m] -= (amt * rate); });
                    } else {
                        const inv = (exp.involved || []).filter(m => balances.hasOwnProperty(m));
                        if(inv.length) { const s = totalTWD / inv.length; inv.forEach(m => balances[m] -= s); }
                    }
                });
                let debtors = [], creditors = [];
                Object.entries(balances).forEach(([n, b]) => { if(b < -0.1) debtors.push({n, a:Math.abs(b)}); else if(b > 0.1) creditors.push({n, a:b}); });
                let plan = [], i=0, j=0; const tRate = this.rates[this.displayCurrency] || 1;
                while(i < debtors.length && j < creditors.length){
                    let d = debtors[i], c = creditors[j], amt = Math.min(d.a, c.a);
                    plan.push({ from: d.n, to: c.n, amount: Math.round(amt/tRate) });
                    d.a -= amt; c.a -= amt;
                    if(d.a < 0.1) i++; if(c.a < 0.1) j++;
                }
                return plan;
            },
            filteredWishlist() { 
                let list = this.wishlist.map((it, idx) => ({ ...it, originalIndex: idx }));
                if (this.wishlistFilterDay !== 'all') list = list.filter(it => it.day === this.wishlistFilterDay);
                return list;
            },
            paginatedWishlist() { return this.filteredWishlist; },
            currentPackingList() { return this.packingList[this.currentPackingMember] || []; },
            packingProgress() { const l = this.currentPackingList; if(!l.length) return 0; return Math.round(l.filter(i=>i.checked).length / l.length * 100); },
            themePresets() { return { wood: {'--theme-main': '#8b5e3c'} }; }
        },
        mounted() { this.loadTripList(); setTimeout(() => this.isLoading = false, 5000); },
        methods: {
            loadTripList() {
                const saved = localStorage.getItem('myTripBooks');
                this.allTrips = saved ? JSON.parse(saved) : {};
                this.syncLocalOrder();
                if (Object.keys(this.allTrips).length > 0) this.openTrip(this.sortedTrips[0].id); else this.createNewTrip();
            },
            syncLocalOrder() {
                const order = JSON.parse(localStorage.getItem('myTripOrder') || '[]');
                const ids = Object.keys(this.allTrips);
                this.localOrder = order.filter(id => ids.includes(id));
                ids.forEach(id => { if(!this.localOrder.includes(id)) this.localOrder.push(id); });
                localStorage.setItem('myTripOrder', JSON.stringify(this.localOrder));
            },
            openTrip(id) {
                this.currentTripId = id;
                const d = this.allTrips[id];
                if (d) {
                    this.tripName = d.tripName || 'æ–°æ—…ç¨‹';
                    this.days = (d.days || [{activities:[]}]).map(day => ({ 
                        ...day, activities: (day.activities || []).map(a => ({...a, showTransportInput: !!a.transportToNext})) 
                    }));
                    this.expenses = d.expenses || [];
                    this.members = d.members || ['æˆ‘', 'æ—…ä¼´'];
                    this.wishlist = d.wishlist || [];
                    this.externalLinks = d.externalLinks || [];
                    this.packingList = d.packingList || {};
                    this.changelog = d.changelog || [];
                    this.startDate = d.startDate || '';
                    this.isLoading = false; this.showSidebar = false;
                    this.$nextTick(() => { if(this.currentTab === 'schedule') this.retryInitMap(0); if(this.currentTab === 'expenses') this.renderChart(); });
                }
            },
            saveData() {
                if (!this.currentTripId) return;
                const data = { tripName: this.tripName, days: this.days, expenses: this.expenses, members: this.members, wishlist: this.wishlist, externalLinks: this.externalLinks, packingList: this.packingList, changelog: this.changelog, startDate: this.startDate, theme: this.allTrips[this.currentTripId].theme || 'wood' };
                this.allTrips[this.currentTripId] = data;
                localStorage.setItem('myTripBooks', JSON.stringify(this.allTrips));
                this.statusMessage = 'Saved ' + new Date().toLocaleTimeString();
            },
            addChangelog(action, title) {
                const now = new Date();
                this.changelog.unshift({ time: `${now.getHours()}:${now.getMinutes()}`, action, title });
                if(this.changelog.length > 10) this.changelog.pop();
            },
            addExpense() {
                if(this.newExpense.title && this.newExpense.amount) {
                    let record = JSON.parse(JSON.stringify(this.newExpense));
                    record.splitType = this.splitMode;
                    if(this.splitMode === 'custom') record.customData = this.customSplitAmounts;
                    if(this.editingExpenseIndex !== null) {
                        this.expenses[this.editingExpenseIndex] = record;
                        this.addChangelog('EDIT', record.title);
                        this.editingExpenseIndex = null;
                    } else {
                        this.expenses.push(record);
                        this.addChangelog('ADD', record.title);
                    }
                    this.cancelEditExpense(); this.saveData();
                }
            },
            editExpenseRecord(idx) {
                this.editingExpenseIndex = idx;
                const exp = this.expenses[idx];
                this.newExpense = JSON.parse(JSON.stringify(exp));
                this.splitMode = exp.splitType || 'equal';
                if(this.splitMode === 'custom') this.customSplitAmounts = exp.customData || {};
                this.$nextTick(() => this.$refs.expenseForm.scrollIntoView({ behavior: 'smooth', block: 'start' }));
            },
            cancelEditExpense() {
                this.editingExpenseIndex = null;
                this.newExpense = { title:'', amount:0, payer:'æˆ‘', currency:'TWD', involved:[...this.members], category:'other', note:'', photo:null, date:new Date().toISOString().split('T')[0] };
            },
            deleteExpense(idx) {
                const t = this.expenses[idx].title;
                this.expenses.splice(idx, 1);
                this.addChangelog('DEL', t); this.saveData();
            },
            handlePhotoUpload(e) {
                const file = e.target.files[0]; if(!file) return;
                const reader = new FileReader(); reader.onload = (res) => { this.newExpense.photo = res.target.result; }; reader.readAsDataURL(file);
            },
            addDay() {
                this.days.splice(this.currentDayIndex + 1, 0, { activities: [], dailyNote: '', color: '' });
                this.changeDay(this.currentDayIndex + 1); this.saveData();
            },
            changeDay(i) { this.currentDayIndex = i; this.$nextTick(() => this.updateMapRoute()); },
            moveDay(idx, dir) {
                const target = idx + dir;
                if (target >= 0 && target < this.days.length) {
                    [this.days[idx], this.days[target]] = [this.days[target], this.days[idx]];
                    if (this.currentDayIndex === idx) this.currentDayIndex = target;
                    else if (this.currentDayIndex === target) this.currentDayIndex = idx;
                    this.saveData();
                }
            },
            deleteDay() { if(confirm('åˆªé™¤æ­¤æ—¥ï¼Ÿ')){ this.days.splice(this.currentDayIndex, 1); if(!this.days.length) this.days.push({activities:[]}); this.currentDayIndex = Math.max(0, this.currentDayIndex-1); this.saveData(); } },
            addActivity() { this.days[this.currentDayIndex].activities.push({ time:'12:00', place:'', note:'', type:'sightseeing' }); this.saveData(); },
            deleteActivity(idx) { this.days[this.currentDayIndex].activities.splice(idx, 1); this.saveData(); },
            addWishItem() { if(this.newWishItem.name){ this.wishlist.push({...this.newWishItem, checked:false}); this.newWishItem = {name:'', day:'all'}; this.saveData(); } },
            openWishEditModal(idx) { this.editingWishIdx = idx; this.editWishTemp = JSON.parse(JSON.stringify(this.wishlist[idx])); this.showWishEditModal = true; },
            saveWishItemEdit() { this.wishlist[this.editingWishIdx] = this.editWishTemp; this.showWishEditModal = false; this.saveData(); },
            addLink() { if(this.newLink.title && this.newLink.url){ this.externalLinks.push({...this.newLink}); this.newLink = {title:'', url:''}; this.saveData(); } },
            deleteLink(idx) { this.externalLinks.splice(idx, 1); this.saveData(); },
            addPackingItem() { if(this.newPackingItem){ if(!this.packingList[this.currentPackingMember]) this.packingList[this.currentPackingMember] = []; this.packingList[this.currentPackingMember].push({name:this.newPackingItem, checked:false}); this.newPackingItem=''; this.saveData(); } },
            deletePackingItem(idx) { this.packingList[this.currentPackingMember].splice(idx,1); this.saveData(); },
            loadDefaultPackingItems() {
                const items = ["è­·ç…§", "å……é›»å™¨", "æ›æ´—è¡£ç‰©", "ç¶²å¡"];
                if(!this.packingList[this.currentPackingMember]) this.packingList[this.currentPackingMember] = [];
                items.forEach(it => this.packingList[this.currentPackingMember].push({name:it, checked:false})); this.saveData();
            },
            createNewTrip() {
                const id = 'trip_' + Date.now();
                const trip = { tripName: 'æ–°è¡Œç¨‹', days: [{activities:[]}], theme:'wood' };
                if (hasFirebase) db.ref('trips/'+id).set(trip);
                this.allTrips[id] = trip; this.openTrip(id);
            },
            confirmDeleteTrip(id) { if(confirm('ç¢ºå®šåˆªé™¤æ•´æœ¬æ›¸ï¼Ÿ')){ if(hasFirebase) db.ref('trips/'+id).remove(); delete this.allTrips[id]; this.loadTripList(); } },
            moveTripBook(idx, dir) {
                const target = idx + dir;
                if(target >= 0 && target < this.sortedTrips.length){
                    const currentIds = this.sortedTrips.map(t => t.id);
                    [currentIds[idx], currentIds[target]] = [currentIds[target], currentIds[idx]];
                    this.localOrder = currentIds; localStorage.setItem('myTripOrder', JSON.stringify(this.localOrder));
                }
            },
            getDateLabel(idx) { if(!this.startDate) return ''; const d = new Date(this.startDate); d.setDate(d.getDate() + idx); return (d.getMonth()+1)+'/'+d.getDate(); },
            autoGrow(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; },
            getCategoryIcon(c) { const m = {food:'ğŸ´', transport:'ğŸš…', accommodation:'ğŸ¨'}; return m[c] || 'ğŸ“¦'; },
            getHour(t) { return t ? t.split(':')[0] : '10'; },
            getMinute(t) { return t ? t.split(':')[1] : '00'; },
            updateTime(item, val, type) { let h = this.getHour(item.time), m = this.getMinute(item.time); item.time = (type==='hour'? `${val}:${m}` : `${h}:${val}`); this.saveData(); },
            getTypeColor(t) { const m = {food:'bg-orange-300', transport:'bg-blue-300', accommodation:'bg-purple-300'}; return m[t] || 'bg-gray-300'; },
            toggleInvolved(m) { const i = this.newExpense.involved.indexOf(m); if(i>-1) this.newExpense.involved.splice(i,1); else this.newExpense.involved.push(m); },
            updateTotalFromCustom() { this.newExpense.amount = Object.values(this.customSplitAmounts).reduce((a,b)=>a+(b||0),0); },
            changeSplitMode(m) { this.splitMode = m; if(m==='custom') this.members.forEach(mem => this.customSplitAmounts[mem]=0); },
            initAutocomplete(idx, e) {
                const auto = new google.maps.places.Autocomplete(e.target);
                auto.addListener('place_changed', () => { 
                    const p = auto.getPlace(); 
                    if(p.name) { this.days[this.currentDayIndex].activities[idx].place = p.name; this.saveData(); this.updateMapRoute(); }
                });
            },
            retryInitMap(a) { if(a<10 && typeof google !== 'undefined') this.initMap(); else if(a<10) setTimeout(()=>this.retryInitMap(a+1), 500); },
            initMap() {
                this.directionsService = new google.maps.DirectionsService();
                this.directionsRenderer = new google.maps.DirectionsRenderer({ map: new google.maps.Map(document.getElementById('google-map'), {zoom:12, center:{lat:35, lng:135}, disableDefaultUI:true}) });
                this.updateMapRoute();
            },
            updateMapRoute() {
                if(!this.directionsService) return;
                const acts = this.days[this.currentDayIndex].activities.filter(a => a.place);
                if(acts.length < 2) { this.directionsRenderer.setDirections({routes:[]}); return; }
                this.directionsService.route({
                    origin: acts[0].place, destination: acts[acts.length-1].place,
                    waypoints: acts.slice(1,-1).map(a => ({location: a.place, stopover: true})),
                    travelMode: 'DRIVING'
                }, (res, status) => { if(status === 'OK') this.directionsRenderer.setDirections(res); });
            },
            renderChart() {
                const ctx = document.getElementById('expenseChart'); if(!ctx) return;
                if(this.chart) this.chart.destroy();
                const data = this.categoryAnalysis;
                this.chart = new Chart(ctx, { type:'doughnut', data:{ labels:data.map(i=>i.label), datasets:[{data:data.map(i=>i.amount), backgroundColor:data.map(i=>i.chartColor)}] }, options:{plugins:{legend:{display:false}}, cutout:'70%'} });
            },
            saveTripSettings() { this.allTrips[this.currentTripId].tripName = this.editTemp.name; this.allTrips[this.currentTripId].theme = this.editTemp.theme; this.saveData(); this.showSettingsModal = false; },
            previewTheme(k) { this.editTemp.theme = k; },
            openTripSettings(id) { this.pendingTripId = id; this.editTemp = { name: this.allTrips[id].tripName, theme: this.allTrips[id].theme || 'wood' }; this.showSettingsModal = true; },
            removeMember(idx) { this.members.splice(idx,1); this.saveData(); },
            addMember() { if(this.newMemberName){ this.members.push(this.newMemberName); this.newMemberName=''; this.saveData(); } }
        }
    }).mount('#app');
</script>
</body>
</html>