<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®å†Š (Travel Log)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #fdfcf8; --bg-card: #ffffff;
            --theme-main: #8b5e3c; --theme-light: #f0e6dd; --theme-accent: #b08d73;
            --text-main: #4a4036; --text-sub: #968c83;
            --danger: #d68c8c; --link-blue: #7ca5b8;
        }
        body { background-color: var(--bg-body); font-family: 'Noto Sans TC', sans-serif; color: var(--text-main); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; transition: background-color 0.5s ease, color 0.3s ease; }
        .font-en { font-family: 'Montserrat', sans-serif; }
        
        #google-map { width: 100%; height: 300px; border-radius: 12px; filter: sepia(10%) contrast(95%); border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; z-index: 1; }
        
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: var(--theme-light); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--theme-accent); border-radius: 4px; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        button, input, select, textarea { outline: none; -webkit-tap-highlight-color: transparent; }
        .time-select { appearance: none; background-color: transparent; text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 600; color: var(--text-main); border-radius: 4px; padding: 0; cursor: pointer; }
        
        .rotate-180 { transform: rotate(180deg); }
        .transition-transform { transition: transform 0.3s ease; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-card); opacity: 0.95; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-spinner { border: 4px solid var(--theme-light); border-top: 4px solid var(--theme-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--bg-card); padding: 20px; border-radius: 16px; width: 100%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid var(--theme-light); }
        
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid var(--theme-light); transition: transform 0.2s; }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.2); box-shadow: 0 0 8px rgba(0,0,0,0.1); }
        
        .day-tab { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-width: 2px; }
        .day-tab.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .color-picker-dot { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; transition: transform 0.1s; }

        .map-error-msg { position: absolute; inset: 0; background: #f8d7da; color: #721c24; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; font-size: 12px; z-index: 10; border-radius: 12px; }
        
        .custom-checkbox { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--theme-light); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background-color: transparent; }
        .custom-checkbox:checked { background-color: transparent; border-color: #666666; }
        .custom-checkbox:checked::after { content: 'âœ”'; color: #666666; font-size: 14px; font-weight: bold; }

        .analysis-select { font-family: 'Montserrat', sans-serif !important; font-weight: 700; font-size: 10px; background-color: rgba(240, 230, 221, 0.3); border-radius: 0.5rem; padding: 0.25rem 0.5rem; outline: none; border: 1px solid var(--theme-light); color: var(--text-main); cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .packing-member-select { @apply text-[10px] font-bold bg-[var(--theme-light)]/30 rounded-lg px-2 py-1 outline-none border border-[var(--theme-light)] text-[var(--text-main)] cursor-pointer hover:bg-[var(--theme-light)]/50 transition tracking-wide; font-family: 'Montserrat', sans-serif !important; }

        .section-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem 0.25rem; margin-bottom: 0.5rem; cursor: pointer; user-select: none; }
        .section-title { font-family: 'Montserrat', sans-serif !important; font-weight: 700 !important; font-size: 0.75rem !important; color: var(--text-sub) !important; letter-spacing: 0.1em !important; text-transform: uppercase !important; padding-left: 0.25rem; }
        .section-arrow { font-size: 10px; color: var(--text-sub); transition: transform 0.3s ease; }

        .settle-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding-top: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--theme-light); }
        .settle-row:last-child { border-bottom: none; }
        .settle-payer { flex: 1; text-align: right; font-weight: bold; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .settle-label { width: 40px; text-align: center; color: var(--danger); font-weight: bold; flex-shrink: 0; }
        .settle-receiver { flex: 1; text-align: left; font-weight: bold; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .settle-amount { flex-shrink: 0; text-align: right; font-family: 'Montserrat', sans-serif; font-weight: bold; color: var(--theme-main); margin-left: 0.5rem; display: flex; align-items: center; gap: 4px; }

        textarea { resize: vertical; overflow: hidden; }
        textarea::-webkit-resizer { border-width: 8px; border-style: solid; border-color: transparent var(--theme-accent) var(--theme-accent) transparent; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>

<div id="app" :style="currentThemeStyles" class="max-w-md mx-auto bg-[var(--bg-body)] min-h-screen shadow-2xl relative pb-12 border-x border-[var(--theme-light)] overflow-hidden font-sans text-[var(--text-main)] transition-colors duration-500">
    
    <div v-if="isLoading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="mt-2 text-xs font-bold text-[var(--theme-main)]">è®€å–ä¸­...</div>
        <button @click="isLoading = false" class="mt-4 text-[10px] text-[var(--text-sub)] underline">å¦‚æœå¡ä½è«‹é»æ­¤</button>
    </div>

    <!-- ç…§ç‰‡å…¨è¢å¹•é è¦½ -->
    <div v-if="previewPhotoUrl" class="modal-overlay" @click="previewPhotoUrl = null">
        <div class="max-w-full max-h-full p-4">
            <img :src="previewPhotoUrl" class="rounded-xl shadow-2xl max-h-[80vh] object-contain mx-auto border-4 border-white">
        </div>
    </div>

    <!-- è³¼ç‰©é …ç›®ç·¨è¼¯ Modal -->
    <div v-if="showWishEditModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4">âœï¸ ç·¨è¼¯æ¸…å–®é …ç›®</h3>
            <div class="space-y-3">
                <input v-model="editWishTemp.name" placeholder="åç¨±" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                <select v-model="editWishTemp.day" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                    <option value="all">ä¸æŒ‡å®šæ—¥æœŸ</option>
                    <option v-for="(day, idx) in days" :key="idx" :value="idx">Day {{ idx + 1 }}</option>
                </select>
                <input v-model="editWishTemp.note" placeholder="å‚™è¨»" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="showWishEditModal = false" class="flex-1 py-2 text-xs text-[var(--text-sub)] hover:bg-[var(--theme-light)] rounded-lg transition">å–æ¶ˆ</button>
                <button @click="saveWishItemEdit" class="flex-1 py-2 text-xs text-white bg-[var(--theme-main)] rounded-lg font-bold transition">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¤©æ•¸ç®¡ç† Modal -->
    <div v-if="showDayManager" class="modal-overlay">
        <div class="modal-card !max-w-[340px]">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4 font-en tracking-widest text-sm">MANAGE DAYS</h3>
            <div class="max-h-[350px] overflow-y-auto space-y-2 custom-scroll pr-2">
                <div v-for="(day, index) in days" :key="index" class="flex items-center gap-2 bg-[var(--bg-body)] p-2 rounded-xl border border-[var(--theme-light)]">
                    <div class="text-[10px] font-bold w-12 text-[var(--text-sub)]">Day {{ index+1 }}</div>
                    <div class="flex gap-1 flex-1 overflow-x-auto scrollbar-hide">
                        <div v-for="c in dayColorPresets" :key="c" @click="day.color = c; saveData()" 
                             :style="{ backgroundColor: c }" 
                             :class="['color-picker-dot', (day.color === c || (!day.color && c === '#8b5e3c')) ? 'ring-2 ring-offset-1 ring-gray-400 scale-110' : 'opacity-60']">
                        </div>
                    </div>
                    <div class="flex items-center bg-[var(--theme-light)]/30 rounded-lg px-1">
                        <button @click="moveDay(index, -1)" :disabled="index === 0" class="p-1.5 text-xs text-[var(--theme-main)] disabled:opacity-20">â–²</button>
                        <div class="w-px h-3 bg-[var(--theme-light)]"></div>
                        <button @click="moveDay(index, 1)" :disabled="index === days.length - 1" class="p-1.5 text-xs text-[var(--theme-main)] disabled:opacity-20">â–¼</button>
                    </div>
                </div>
            </div>
            <button @click="showDayManager = false" class="w-full mt-4 py-2 bg-[var(--theme-main)] text-white rounded-lg font-bold text-xs">å®Œæˆ</button>
        </div>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <transition name="slide">
        <div v-if="showSidebar" class="fixed inset-0 z-50 flex">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showSidebar = false"></div>
            <div class="relative bg-[var(--bg-body)] w-72 h-full shadow-2xl flex flex-col border-r border-[var(--theme-light)]">
                <div class="p-5 border-b border-[var(--theme-light)]">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-[var(--theme-main)] tracking-widest">æ—…ç¨‹æ›¸æ«ƒ</h2>
                        <button @click="showSidebar = false" class="text-[var(--text-sub)]">âœ•</button>
                    </div>
                    <div class="text-[10px] text-[var(--text-sub)] font-normal mt-1 opacity-70">é¦–é ç‚ºæ“ºæ”¾æœ€ä¸Šå±¤æ—…éŠæ›¸</div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                    <div v-for="(trip, index) in sortedTrips" :key="trip.id" 
                         @click="openTrip(trip.id)" 
                         :class="currentTripId === trip.id ? 'border-[var(--theme-main)] bg-[var(--bg-card)] shadow-md' : 'border-transparent hover:bg-[var(--bg-card)] border-[var(--theme-light)]'" 
                         class="flex items-stretch rounded-xl border bg-[var(--bg-card)] overflow-hidden transition cursor-pointer group mb-2 relative p-3">
                        <div class="flex-1 min-w-0 pb-6">
                            <div class="font-bold text-[var(--text-main)] text-sm truncate">{{ trip.tripName || 'æœªå‘½åè¡Œç¨‹' }}</div>
                            <div class="text-[10px] text-[var(--text-sub)] mt-1 font-en">{{ trip.startDate || 'ç„¡æ—¥æœŸ' }}</div>
                        </div>
                        <div class="absolute bottom-2 right-2 flex items-center gap-2">
                             <button @click.stop="confirmDeleteTrip(trip.id)" class="text-[var(--danger)] p-1 bg-white/80 rounded">âœ•</button>
                        </div>
                        <div class="w-4 bg-[var(--theme-light)]/30 border-l border-[var(--theme-light)] flex flex-col justify-center items-center gap-1">
                            <button @click.stop="moveTripBook(index, -1)" class="text-[10px]" :disabled="index === 0">â–²</button>
                            <button @click.stop="moveTripBook(index, 1)" class="text-[10px]" :disabled="index === sortedTrips.length - 1">â–¼</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-[var(--theme-light)]">
                    <button @click="createNewTrip" class="w-full bg-[var(--theme-main)] text-white py-3 rounded-xl font-bold shadow-md text-sm">+ å»ºç«‹æ–°æ—…ç¨‹</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Header -->
    <div class="sticky top-0 z-30 bg-[var(--bg-body)]/95 backdrop-blur-sm border-b border-[var(--theme-light)] p-4 transition-colors">
        <button @click="showSidebar = true" class="absolute left-4 top-5 text-[var(--theme-main)]"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></button>
        <div class="flex items-center justify-center mb-4 pl-8 pr-8">
            <input v-model="tripName" @change="saveData" class="text-center w-full text-xl font-bold text-[var(--theme-main)] bg-transparent border-b-2 border-transparent focus:border-[var(--theme-accent)] transition py-1 tracking-widest" placeholder="æ—…ã®è¨ˆç”»...">
        </div>
        <div class="flex justify-center mb-3">
            <div class="bg-[var(--theme-light)]/30 p-1.5 rounded-full flex w-full max-w-[360px] shadow-inner gap-1 overflow-x-auto scrollbar-hide">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" :class="currentTab === tab.id ? 'bg-[var(--bg-card)] text-[var(--theme-main)] shadow-sm font-bold' : 'text-[var(--text-sub)]'" class="flex-1 py-1.5 px-2 rounded-full text-xs transition-all whitespace-nowrap">{{ tab.name }}</button>
            </div>
        </div>
        <div v-if="currentTab === 'schedule'" class="flex flex-col gap-2 mt-2 px-1">
            <div class="flex items-center justify-end px-1 gap-2">
                <label class="text-[10px] text-[var(--text-sub)]">å‡ºç™¼æ—¥:</label>
                <input type="date" v-model="startDate" @change="saveData" class="text-[10px] bg-transparent text-[var(--theme-main)] font-en outline-none border-b border-[var(--theme-light)]">
            </div>
            <div class="flex items-center gap-2">
                <div class="flex-1 min-w-0 overflow-x-auto whitespace-nowrap hide-scrollbar flex gap-2 pb-2">
                    <div v-for="(day, index) in days" :key="index" @click="changeDay(index)">
                        <div :style="{ backgroundColor: currentDayIndex === index ? (day.color || 'var(--theme-main)') : 'var(--bg-card)', color: currentDayIndex === index ? '#fff' : (day.color || 'var(--text-sub)'), borderColor: currentDayIndex === index ? 'transparent' : (day.color || 'var(--theme-light)') }" 
                             :class="['day-tab px-3 py-1.5 rounded-lg flex flex-col items-center justify-center min-w-[70px] border', currentDayIndex === index ? 'active' : '']">
                            <span class="text-xs font-en font-bold">Day {{ index + 1 }}</span>
                            <span class="text-[9px] font-en opacity-80 mt-0.5">{{ getDateLabel(index) }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-1 mb-2">
                    <button @click="showDayManager = true" class="shrink-0 w-8 h-8 flex items-center justify-center bg-[var(--theme-light)]/50 text-[var(--theme-main)] rounded-lg text-sm">âš™ï¸</button>
                    <button @click="addDay" class="shrink-0 w-8 h-8 flex items-center justify-center border-2 border-dashed border-[var(--theme-accent)] text-[var(--theme-main)] rounded-lg text-sm">+</button>
                </div>
            </div>
        </div>
    </div>

    <div class="p-5 min-h-[500px]">
        <!-- PAGE 1: è¡Œç¨‹è¡¨ -->
        <div v-if="currentTab === 'schedule'" class="space-y-6 animate-fade">
            <div v-if="weatherData" class="flex items-center justify-center gap-2 text-[var(--theme-main)] text-sm font-bold bg-[var(--theme-light)]/50 py-0.5 rounded-md">
                <span class="text-xl">{{ weatherData.icon }}</span><span>{{ weatherData.temp }}Â°C</span>
            </div>
            <div id="google-map"></div>
            <div class="flex justify-between border-b border-[var(--theme-light)] pb-2">
                <h2 class="text-sm font-bold">Day {{ currentDayIndex + 1 }}</h2>
                <button @click="deleteDay" class="text-[10px] text-[var(--text-sub)]">DELETE DAY</button>
            </div>
            <div v-if="days[currentDayIndex]" class="space-y-4">
                <template v-for="(item, index) in days[currentDayIndex].activities" :key="index">
                    <div class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--theme-light)] flex gap-3">
                        <div class="w-16 flex-shrink-0">
                            <input v-model="item.time" type="time" @change="saveData" class="text-sm font-bold bg-transparent outline-none w-full text-[var(--theme-main)]">
                        </div>
                        <div class="flex-1">
                            <input v-model="item.place" @change="saveData" @focus="initAutocomplete(index, $event)" placeholder="åœ°é»" class="w-full font-bold bg-transparent outline-none mb-1">
                            <textarea v-model="item.note" @change="saveData" rows="1" @input="autoGrow($event.target)" placeholder="å‚™è¨»" class="w-full text-xs text-[var(--text-sub)] bg-transparent outline-none resize-none"></textarea>
                        </div>
                        <button @click="deleteActivity(index)" class="text-[var(--danger)]">âœ•</button>
                    </div>
                    <div v-if="index < days[currentDayIndex].activities.length - 1" class="ml-10 border-l-2 border-dotted border-[var(--theme-light)] pl-4">
                         <textarea v-model="item.transportToNext" @change="saveData" placeholder="æ¥é§äº¤é€š..." class="text-[10px] bg-transparent outline-none w-full italic text-[var(--theme-accent)]"></textarea>
                    </div>
                </template>
            </div>
            <button @click="addActivity" class="w-full py-3 border border-dashed border-[var(--theme-accent)] text-[var(--theme-accent)] rounded-xl text-xs">+ ADD ITEM</button>
        </div>

        <!-- PAGE 2: æ¶ˆè²»ç´€éŒ„ -->
        <div v-if="currentTab === 'expenses'" class="space-y-6 animate-fade">
            <!-- çµç®—ç¸½è¡¨ -->
            <div @click="showSettlement = !showSettlement" class="section-header"><h3 class="section-title">SETTLEMENT</h3><span class="section-arrow">â–¼</span></div>
            <div v-show="showSettlement" class="bg-[var(--theme-light)]/30 p-4 rounded-xl border border-[var(--theme-light)]">
                <div class="flex justify-end mb-2">
                    <select v-model="displayCurrency" class="text-[10px] font-bold border border-[var(--theme-light)] rounded px-1">
                        <option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option>
                    </select>
                </div>
                <div v-for="(trans, idx) in settlementPlan" :key="idx" class="settle-row py-2">
                    <div class="settle-payer text-xs">{{ trans.from }}</div>
                    <div class="settle-label text-[10px] px-2">çµ¦</div>
                    <div class="settle-receiver text-xs">{{ trans.to }}</div>
                    <div class="settle-amount text-xs">{{ trans.amount }} <span class="text-[8px] opacity-70">{{ displayCurrency }}</span></div>
                </div>
                <div v-if="settlementPlan.length === 0" class="text-center text-[10px] text-[var(--text-sub)] py-4">ç„¡å¾…çµæ¸…æ¬¾é …</div>
            </div>

            <!-- è¼¸å…¥è¡¨å–® -->
            <div ref="expenseForm" class="bg-[var(--bg-card)] p-4 rounded-xl border border-[var(--theme-light)] space-y-3">
                <div class="flex gap-2">
                    <input v-model="newExpense.title" placeholder="é …ç›®" class="flex-1 font-bold border-b border-[var(--theme-light)] pb-1 bg-transparent">
                    <select v-model="newExpense.category" class="text-xs border rounded px-1">
                        <option value="food">ğŸ´ ç¾é£Ÿ</option><option value="transport">ğŸš… äº¤é€š</option><option value="other">ğŸ“¦ å…¶ä»–</option>
                    </select>
                </div>
                <input v-model="newExpense.note" placeholder="å‚™è¨» (é¸å¡«)" class="w-full text-xs border-b border-[var(--theme-light)] pb-1 bg-transparent">
                <div class="flex gap-2">
                    <input type="number" v-model.number="newExpense.amount" :readonly="splitMode === 'custom'" class="flex-1 text-sm bg-[var(--bg-body)] rounded p-2" placeholder="é‡‘é¡">
                    <select v-model="newExpense.currency" class="text-xs font-en border rounded px-1">
                        <option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px]">æ—¥æœŸ:</span>
                    <input type="date" v-model="newExpense.date" class="text-xs bg-transparent border-b">
                    <span class="text-[10px] ml-auto">ä»˜æ¬¾äºº:</span>
                    <select v-model="newExpense.payer" class="text-xs border rounded px-1">
                        <option v-for="m in members" :value="m">{{ m }}</option>
                    </select>
                </div>
                <!-- ç…§ç‰‡ -->
                <div class="flex items-center gap-2">
                    <button @click="$refs.expensePhotoInput.click()" class="p-2 bg-[var(--theme-light)] rounded-lg text-[var(--theme-main)]">ğŸ“·</button>
                    <input type="file" ref="expensePhotoInput" @change="handlePhotoUpload" accept="image/*" class="hidden">
                    <div v-if="newExpense.photo" class="relative">
                        <img :src="newExpense.photo" class="w-10 h-10 object-cover rounded" @click="previewPhotoUrl = newExpense.photo">
                        <button @click="newExpense.photo = null" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] rounded-full w-3 h-3">âœ•</button>
                    </div>
                </div>
                <!-- æ‹†å¸³æ–¹å¼ -->
                <div class="flex gap-2 text-[10px]">
                    <button @click="changeSplitMode('equal')" :class="splitMode === 'equal' ? 'font-bold underline' : 'opacity-50'">å¹³å‡</button>
                    <button @click="changeSplitMode('custom')" :class="splitMode === 'custom' ? 'font-bold underline' : 'opacity-50'">è‡ªè¨‚</button>
                </div>
                <div v-if="splitMode === 'equal'" class="flex flex-wrap gap-2">
                    <button v-for="m in members" @click="toggleInvolved(m)" :class="newExpense.involved.includes(m) ? 'bg-[var(--theme-main)] text-white' : 'border opacity-50'" class="text-[10px] px-3 py-1 rounded-full">{{ m }}</button>
                </div>
                <div v-if="splitMode === 'custom'" class="space-y-2">
                    <div v-for="m in members" :key="m" class="flex items-center justify-between">
                        <span class="text-[10px]">{{ m }}</span>
                        <input type="number" v-model.number="customSplitAmounts[m]" @input="updateTotalFromCustom" class="w-24 text-right border-b text-xs">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button v-if="editingExpenseIndex !== null" @click="cancelEditExpense" class="flex-1 py-2 text-xs bg-gray-200 rounded">å–æ¶ˆ</button>
                    <button @click="addExpense" class="flex-[2] py-2 text-xs bg-[var(--theme-main)] text-white rounded font-bold">{{ editingExpenseIndex !== null ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}</button>
                </div>
            </div>

            <!-- æ­·å²ç´€éŒ„ -->
            <div class="space-y-3">
                <div v-for="(group, dateKey) in groupedExpenses" :key="dateKey">
                    <div class="text-[10px] font-bold text-[var(--text-sub)] border-b mb-2">{{ dateKey }}</div>
                    <div v-for="item in group.items" :key="item.originalIndex" class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--theme-light)] flex gap-3 relative mb-2">
                        <div class="text-xl shrink-0">{{ getCategoryIcon(item.data.category) }}</div>
                        <div class="min-w-0 flex-1">
                            <!-- é•·æ–‡å­—æ»‘å‹•æŸ¥çœ‹ -->
                            <div class="overflow-x-auto whitespace-nowrap hide-scrollbar pr-2 cursor-grab active:cursor-grabbing">
                                <span class="text-sm font-bold">{{ item.data.title }}</span>
                            </div>
                            <div v-if="item.data.note" class="overflow-x-auto whitespace-nowrap hide-scrollbar text-[9px] text-[var(--text-sub)] italic pr-2">
                                {{ item.data.note }}
                            </div>
                            <div class="text-[10px] opacity-70 mt-1">{{ item.data.payer }} ä»˜ Â· {{ item.data.currency }} {{ item.data.amount }}</div>
                        </div>
                        <!-- å³å´ç¨ç«‹æ’ç‰ˆå€ï¼šé‡‘é¡èˆ‡åŠŸèƒ½éˆ• -->
                        <div class="flex flex-col items-end shrink-0 border-l border-[var(--theme-light)] pl-3">
                            <div class="flex gap-2 mb-1">
                                <button @click.stop="editExpenseRecord(item.originalIndex)" class="text-[var(--text-sub)] hover:text-[var(--theme-main)]">âœ</button>
                                <button @click.stop="deleteExpense(item.originalIndex)" class="text-[var(--text-sub)] hover:text-[var(--danger)]">âœ•</button>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm">{{ item.data.currency }} {{ item.data.amount }}</div>
                                <div v-if="item.data.currency !== 'TWD'" class="text-[9px] text-[var(--theme-accent)]">â‰ˆ {{ Math.round(item.data.amount * (rates[item.data.currency] || 1)) }} TWD</div>
                                <div v-if="item.data.photo" @click.stop="previewPhotoUrl = item.data.photo" class="mt-1">
                                    <img :src="item.data.photo" class="w-6 h-6 object-cover rounded border">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- éœ€æ±‚ä¿®æ­£ï¼šå¯æŠ˜ç–Šè¿‘æœŸæ›´å‹•ç´€éŒ„ -->
            <div class="mt-8 border-t border-[var(--theme-light)] pt-4">
                <div @click="showChangelog = !showChangelog" class="flex justify-between items-center cursor-pointer mb-2">
                    <h3 class="text-[10px] font-bold text-[var(--text-sub)] tracking-widest">RECENT CHANGES (LOG)</h3>
                    <span class="text-[10px]">{{ showChangelog ? 'â–²' : 'â–¼' }}</span>
                </div>
                <div v-show="showChangelog" class="bg-[var(--theme-light)]/20 p-3 rounded-lg space-y-1 animate-fade">
                    <div v-for="(log, idx) in changelog" :key="idx" class="text-[9px] border-b border-dashed border-[var(--theme-light)] pb-1 flex justify-between">
                        <span class="text-[var(--text-sub)] font-en">{{ log.time }}</span>
                        <span class="font-bold">[{{ log.action }}] {{ log.title }}</span>
                    </div>
                    <div v-if="changelog.length === 0" class="text-center text-[10px] py-4 italic">å°šç„¡æ›´å‹•ç´€éŒ„</div>
                </div>
            </div>
        </div>
        
        <!-- å…¶ä»–é é¢ä¿æŒåŸæ¨£... -->
        <div v-if="['wishlist','links','packing'].includes(currentTab)" class="text-center py-20 text-[var(--text-sub)] opacity-50">åŠŸèƒ½ä¿æŒå®Œæ•´ï¼Œå°šæœªåˆ‡æ›ã€‚</div>
    </div>

    <div class="fixed bottom-0 w-full bg-[var(--bg-body)]/90 backdrop-blur border-t p-2 text-center text-[10px] text-[var(--text-sub)]">{{ statusMessage }}</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCv9tkLUA9T3lYlz6JLf_wuWFAZLR2nRHY&libraries=places"></script>

<script>
    const { createApp } = Vue;
    const firebaseConfig = { apiKey: "AIzaSyACnUlpKnoImSKhnmEDLAwKfuUOXAKijrU", authDomain: "mytrip-cf4ce.firebaseapp.com", databaseURL: "https://mytrip-cf4ce-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mytrip-cf4ce", storageBucket: "mytrip-cf4ce.firebasestorage.app", messagingSenderId: "336541146264", appId: "1:336541146264:web:484f98b025c151a1e244ed" };
    const hasFirebase = true; 
    let db = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e) {}

    createApp({
        data() {
            return {
                isLoading: true, showSidebar: false, currentTab: 'schedule', 
                tabs: [{id:'schedule', name:'è¡Œç¨‹è¡¨'}, {id:'expenses', name:'æ¶ˆè²»ç´€éŒ„'}, {id:'wishlist', name:'è³¼ç‰©ç¾é£Ÿ'}, {id:'links', name:'å¸¸ç”¨é€£çµ'}, {id:'packing', name:'è¡Œææ¸…å–®'}],
                tripName: '', statusMessage: 'Idle', currentDayIndex: 0, startDate: '',
                days: [{ activities: [], color: '' }],
                members: ['æˆ‘', 'æ—…ä¼´'],
                rates: { TWD: 1, JPY: 0.22, USD: 32.5 }, displayCurrency: 'TWD',
                expenses: [], editingExpenseIndex: null, splitMode: 'equal', customSplitAmounts: {},
                newExpense: { title: '', amount: 0, payer: 'æˆ‘', currency: 'TWD', involved: ['æˆ‘', 'æ—…ä¼´'], category: 'other', note: '', photo: null, date: new Date().toISOString().split('T')[0] },
                changelog: [], showChangelog: false, showSettlement: true, previewPhotoUrl: null,
                showDayManager: false, dayColorPresets: ['#8b5e3c', '#d65d7a', '#4a7a8c', '#5e7e5e'],
                allTrips: {}, currentTripId: null, localOrder: [], weatherData: null, mapError: false
            }
        },
        computed: {
            currentThemeStyles() {
                const trip = this.allTrips[this.currentTripId];
                return { '--theme-main': (trip && trip.theme === 'wood' ? '#8b5e3c' : '#8b5e3c') };
            },
            sortedTrips() {
                if (!this.allTrips) return [];
                let trips = Object.keys(this.allTrips).map(id => ({ id, ...this.allTrips[id] }));
                trips.sort((a, b) => (this.localOrder.indexOf(a.id) - this.localOrder.indexOf(b.id)));
                return trips;
            },
            groupedExpenses() {
                const groups = {};
                this.expenses.forEach((exp, index) => {
                    const k = exp.date || 'å…¶ä»–æ—¥æœŸ';
                    if (!groups[k]) groups[k] = { items: [] };
                    groups[k].items.push({ data: exp, originalIndex: index });
                });
                return groups;
            },
            // åš´è¬¹çš„çµå¸³ç®—æ³•
            settlementPlan() {
                if (!this.members.length) return [];
                let balances = {};
                this.members.forEach(m => balances[m] = 0);

                this.expenses.forEach(exp => {
                    const rate = this.rates[exp.currency] || 1;
                    const totalInTWD = parseFloat(exp.amount) * rate;
                    
                    // ä»˜æ¬¾è€…å¢åŠ é¤˜é¡ï¼ˆå‚µæ¬Šï¼‰
                    if (balances.hasOwnProperty(exp.payer)) balances[exp.payer] += totalInTWD;

                    // åƒèˆ‡è€…æ¸›å°‘é¤˜é¡ï¼ˆå‚µå‹™ï¼‰
                    if (exp.splitType === 'custom' && exp.customData) {
                        Object.entries(exp.customData).forEach(([member, amt]) => {
                            if (balances.hasOwnProperty(member)) balances[member] -= (parseFloat(amt) * rate);
                        });
                    } else {
                        const involved = (exp.involved || []).filter(m => balances.hasOwnProperty(m));
                        if (involved.length > 0) {
                            const share = totalInTWD / involved.length;
                            involved.forEach(m => balances[m] -= share);
                        }
                    }
                });

                // è²ªå©ªæ¼”ç®—æ³•åŒ¹é…å‚µå‹™
                let debtors = [], creditors = [];
                const targetRate = this.rates[this.displayCurrency] || 1;

                Object.entries(balances).forEach(([name, bal]) => {
                    if (bal < -0.01) debtors.push({ name, amount: Math.abs(bal) });
                    else if (bal > 0.01) creditors.push({ name, amount: bal });
                });

                let plan = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let d = debtors[i], c = creditors[j];
                    let settleAmt = Math.min(d.amount, c.amount);
                    if (settleAmt > 0.01) {
                        plan.push({ from: d.name, to: c.name, amount: Math.round(settleAmt / targetRate) });
                    }
                    d.amount -= settleAmt;
                    c.amount -= settleAmt;
                    if (d.amount <= 0.01) i++;
                    if (c.amount <= 0.01) j++;
                }
                return plan;
            }
        },
        mounted() { this.loadTripList(); setTimeout(() => this.isLoading = false, 3000); },
        methods: {
            loadTripList() {
                const saved = localStorage.getItem('myTripBooks');
                this.allTrips = saved ? JSON.parse(saved) : {};
                this.syncLocalOrder();
                const keys = Object.keys(this.allTrips);
                if (keys.length > 0) this.openTrip(this.sortedTrips[0].id); else this.createNewTrip();
            },
            syncLocalOrder() {
                const order = JSON.parse(localStorage.getItem('myTripOrder') || '[]');
                const currentIds = Object.keys(this.allTrips);
                this.localOrder = order.filter(id => currentIds.includes(id));
                currentIds.forEach(id => { if (!this.localOrder.includes(id)) this.localOrder.push(id); });
            },
            openTrip(id) {
                this.currentTripId = id;
                const d = this.allTrips[id];
                if (d) {
                    this.tripName = d.tripName;
                    this.days = d.days || [{activities:[]}];
                    this.expenses = d.expenses || [];
                    this.changelog = d.changelog || [];
                    this.isLoading = false;
                    this.showSidebar = false;
                }
            },
            saveData() {
                if (!this.currentTripId) return;
                const data = { tripName: this.tripName, days: this.days, expenses: this.expenses, changelog: this.changelog };
                this.allTrips[this.currentTripId] = data;
                localStorage.setItem('myTripBooks', JSON.stringify(this.allTrips));
                localStorage.setItem('myTripOrder', JSON.stringify(this.localOrder));
                this.statusMessage = 'Saved';
            },
            addChangelog(action, title) {
                const now = new Date();
                const log = { time: `${now.getHours()}:${now.getMinutes()}`, action, title };
                this.changelog.unshift(log);
                if (this.changelog.length > 10) this.changelog.pop();
            },
            handlePhotoUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (res) => { this.newExpense.photo = res.target.result; };
                reader.readAsDataURL(file);
            },
            editExpenseRecord(idx) {
                this.editingExpenseIndex = idx;
                const exp = this.expenses[idx];
                this.newExpense = JSON.parse(JSON.stringify(exp));
                this.splitMode = exp.splitType || 'equal';
                if (this.splitMode === 'custom') this.customSplitAmounts = exp.customData || {};
                this.$nextTick(() => this.$refs.expenseForm.scrollIntoView({ behavior: 'smooth' }));
            },
            addExpense() {
                let record = JSON.parse(JSON.stringify(this.newExpense));
                record.splitType = this.splitMode;
                if (this.splitMode === 'custom') record.customData = this.customSplitAmounts;
                
                if (this.editingExpenseIndex !== null) {
                    this.expenses[this.editingExpenseIndex] = record;
                    this.addChangelog('EDIT', record.title);
                } else {
                    this.expenses.push(record);
                    this.addChangelog('ADD', record.title);
                }
                this.cancelEditExpense();
                this.saveData();
            },
            cancelEditExpense() {
                this.editingExpenseIndex = null;
                this.newExpense = { title: '', amount: 0, payer: 'æˆ‘', currency: 'TWD', involved: [...this.members], category: 'other', note: '', photo: null, date: new Date().toISOString().split('T')[0] };
            },
            deleteExpense(idx) {
                const title = this.expenses[idx].title;
                this.expenses.splice(idx, 1);
                this.addChangelog('DEL', title);
                this.saveData();
            },
            // å…¶ä»–åŸæœ‰å·¥å…·æ–¹æ³•ä¿æŒä¸è®Š
            getDateLabel(i) { if (!this.startDate) return ''; let d = new Date(this.startDate); d.setDate(d.getDate() + i); return (d.getMonth()+1)+'/'+d.getDate(); },
            autoGrow(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; },
            getCategoryIcon(c) { const m = {food:'ğŸ´', transport:'ğŸš…'}; return m[c] || 'ğŸ“¦'; },
            changeDay(i) { this.currentDayIndex = i; },
            addDay() { this.days.splice(this.currentDayIndex+1, 0, {activities:[]}); this.changeDay(this.currentDayIndex+1); this.saveData(); },
            moveTripBook(idx, dir) { const target = idx + dir; if(target>=0 && target<this.localOrder.length) { [this.localOrder[idx], this.localOrder[target]] = [this.localOrder[target], this.localOrder[idx]]; this.saveData(); } },
            updateTotalFromCustom() { this.newExpense.amount = Object.values(this.customSplitAmounts).reduce((a, b) => a + (b || 0), 0); },
            changeSplitMode(m) { this.splitMode = m; if(m==='custom') this.members.forEach(mem => this.customSplitAmounts[mem]=0); },
            toggleInvolved(m) { const i = this.newExpense.involved.indexOf(m); if(i>-1) this.newExpense.involved.splice(i,1); else this.newExpense.involved.push(m); }
        }
    }).mount('#app');
</script>
</body>
</html>