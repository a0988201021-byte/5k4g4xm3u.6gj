<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®å†Š (Travel Log)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #fdfcf8; --bg-card: #ffffff;
            --theme-main: #8b5e3c; --theme-light: #f0e6dd; --theme-accent: #b08d73;
            --text-main: #4a4036; --text-sub: #968c83;
            --danger: #d68c8c; --link-blue: #7ca5b8;
        }
        body { background-color: var(--bg-body); font-family: 'Noto Sans TC', sans-serif; color: var(--text-main); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; transition: background-color 0.5s ease, color 0.3s ease; }
        .font-en { font-family: 'Montserrat', sans-serif; }
        
        #google-map { width: 100%; height: 300px; border-radius: 12px; filter: sepia(10%) contrast(95%); border: 4px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; z-index: 1; }
        
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: var(--theme-light); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--theme-accent); border-radius: 4px; }

        button, input, select, textarea { outline: none; -webkit-tap-highlight-color: transparent; }
        .time-select { appearance: none; background-color: transparent; text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 600; color: var(--text-main); border-radius: 4px; padding: 0; cursor: pointer; }
        
        .rotate-180 { transform: rotate(180deg); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-card); opacity: 0.95; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-spinner { border: 4px solid var(--theme-light); border-top: 4px solid var(--theme-main); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--bg-card); padding: 20px; border-radius: 16px; width: 100%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid var(--theme-light); }
        
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid var(--theme-light); transition: transform 0.2s; }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.2); box-shadow: 0 0 8px rgba(0,0,0,0.1); }
        .map-error-msg { position: absolute; inset: 0; background: #f8d7da; color: #721c24; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; font-size: 12px; z-index: 10; border-radius: 12px; }
        
        .custom-checkbox { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--theme-light); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background-color: transparent; }
        .custom-checkbox:checked { background-color: transparent; border-color: #666666; }
        .custom-checkbox:checked::after { content: 'âœ”'; color: #666666; font-size: 14px; font-weight: bold; }

        .analysis-select { font-family: 'Montserrat', sans-serif !important; font-weight: 700; font-size: 10px; background-color: rgba(240, 230, 221, 0.3); border-radius: 0.5rem; padding: 0.25rem 0.5rem; outline: none; border: 1px solid var(--theme-light); color: var(--text-main); cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .packing-member-select { @apply text-[10px] font-bold bg-[var(--theme-light)]/30 rounded-lg px-2 py-1 outline-none border border-[var(--theme-light)] text-[var(--text-main)] cursor-pointer hover:bg-[var(--theme-light)]/50 transition tracking-wide; font-family: 'Montserrat', sans-serif !important; }

        .section-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem 0.25rem; margin-bottom: 0.5rem; cursor: pointer; user-select: none; }
        .section-title { font-family: 'Montserrat', sans-serif !important; font-weight: 700 !important; font-size: 0.75rem !important; color: var(--text-sub) !important; letter-spacing: 0.1em !important; text-transform: uppercase !important; padding-left: 0.25rem; }
        .section-arrow { font-size: 10px; color: var(--text-sub); transition: transform 0.3s ease; }

        .settle-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; padding-top: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--theme-light); }
        .settle-row:last-child { border-bottom: none; }
        .settle-payer { flex: 1; text-align: right; font-weight: bold; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .settle-label { width: 40px; text-align: center; color: var(--danger); font-weight: bold; flex-shrink: 0; }
        .settle-receiver { flex: 1; text-align: left; font-weight: bold; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .settle-amount { flex-shrink: 0; text-align: right; font-family: 'Montserrat', sans-serif; font-weight: bold; color: var(--theme-main); margin-left: 0.5rem; display: flex; align-items: center; gap: 4px; }

        textarea { resize: vertical; overflow: hidden; }
        textarea::-webkit-resizer { border-width: 8px; border-style: solid; border-color: transparent var(--theme-accent) var(--theme-accent) transparent; }
    </style>
</head>
<body>

<div id="app" :style="currentThemeStyles" class="max-w-md mx-auto bg-[var(--bg-body)] min-h-screen shadow-2xl shadow-gray-200/50 relative pb-12 border-x border-[var(--theme-light)] overflow-hidden font-sans text-[var(--text-main)] transition-colors duration-500">
    
    <div v-if="isLoading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="mt-2 text-xs font-bold text-[var(--theme-main)]">è®€å–ä¸­...</div>
        <button @click="isLoading = false" class="mt-4 text-[10px] text-[var(--text-sub)] underline">å¦‚æœå¡ä½è«‹é»æ­¤</button>
    </div>

    <!-- è³¼ç‰©é …ç›®ç·¨è¼¯ Modal -->
    <div v-if="showWishEditModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4">âœï¸ ç·¨è¼¯æ¸…å–®é …ç›®</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] text-[var(--text-sub)] block mb-1">åç¨±</label>
                    <input v-model="editWishTemp.name" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] text-[var(--text-sub)] block mb-1">é å®šå¤©æ•¸</label>
                    <select v-model="editWishTemp.day" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="all">ä¸æŒ‡å®šæ—¥æœŸ</option>
                        <option v-for="(day, idx) in days" :key="idx" :value="idx">Day {{ idx + 1 }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-[var(--text-sub)] block mb-1">å‚™è¨» / é€£çµ / åœ°å€</label>
                    <input v-model="editWishTemp.note" placeholder="å‚™è¨»" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none mb-2">
                    <input v-model="editWishTemp.url" placeholder="é€£çµ URL" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none mb-2">
                    <input v-model="editWishTemp.address" placeholder="åœ°å€" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="showWishEditModal = false" class="flex-1 py-2 text-xs text-[var(--text-sub)] hover:bg-[var(--theme-light)] rounded-lg transition">å–æ¶ˆ</button>
                <button @click="saveWishItemEdit" class="flex-1 py-2 text-xs text-white bg-[var(--theme-main)] hover:bg-[var(--theme-accent)] rounded-lg font-bold transition">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- è¡Œç¨‹è¨­å®š Modal -->
    <div v-if="showSettingsModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="text-center font-bold text-[var(--theme-main)] mb-4">âš™ï¸ è¡Œç¨‹è¨­å®š</h3>
            <label class="text-xs text-[var(--text-sub)] block mb-1">æ—…ç¨‹åç¨±</label>
            <input v-model="editTemp.name" class="w-full bg-[var(--bg-body)] border border-[var(--theme-light)] rounded-lg px-3 py-2 text-sm outline-none focus:border-[var(--theme-accent)] mb-4 text-[var(--text-main)] placeholder-[var(--text-sub)]">
            <label class="text-xs text-[var(--text-sub)] block mb-3">ä¸»é¡Œé…è‰² (é»æ“Šé è¦½)</label>
            <div class="flex justify-center gap-4 mb-6">
                <div v-for="(theme, key) in themePresets" :key="key" class="color-dot" :class="{ active: editTemp.theme === key }" :style="{ backgroundColor: theme['--theme-main'] }" @click="previewTheme(key)" :title="key"></div>
            </div>
            <div class="flex gap-2">
                <button @click="cancelSettings" class="flex-1 py-2 text-xs text-[var(--text-sub)] hover:bg-[var(--theme-light)] rounded-lg transition">å–æ¶ˆ</button>
                <button @click="saveTripSettings" class="flex-1 py-2 text-xs text-white bg-[var(--theme-main)] hover:bg-[var(--theme-accent)] rounded-lg font-bold transition">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- å´é‚Šé¸å–® -->
    <transition name="slide">
        <div v-if="showSidebar" class="fixed inset-0 z-50 flex">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showSidebar = false"></div>
            <div class="relative bg-[var(--bg-body)] w-72 h-full shadow-2xl flex flex-col border-r border-[var(--theme-light)]">
                <div class="p-5 border-b border-[var(--theme-light)] flex justify-between items-center">
                    <h2 class="text-lg font-bold text-[var(--theme-main)] tracking-widest">æ—…ç¨‹æ›¸æ«ƒ</h2>
                    <button @click="showSidebar = false" class="text-[var(--text-sub)]">âœ•</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                    <div v-for="(trip, index) in sortedTrips" :key="trip.id" 
                         @click="openTrip(trip.id)" 
                         :class="currentTripId === trip.id ? 'border-[var(--theme-main)] bg-[var(--bg-card)] shadow-md' : 'border-transparent hover:bg-[var(--bg-card)] border-[var(--theme-light)]'" 
                         class="flex items-stretch rounded-xl border bg-[var(--bg-card)] overflow-hidden transition cursor-pointer group mb-2 relative">
                        <div class="flex-1 p-3 flex flex-col justify-between min-w-0 relative pb-8">
                            <div>
                                <div class="font-bold text-[var(--text-main)] text-sm truncate">{{ trip.tripName || 'æœªå‘½åè¡Œç¨‹' }}</div>
                                <div class="text-[10px] text-[var(--text-sub)] mt-1 font-en">{{ trip.startDate || 'ç„¡æ—¥æœŸ' }}</div>
                            </div>
                            <div class="absolute bottom-2 right-2 flex items-center gap-2 z-20">
                                <button type="button" @click.stop="openTripSettings(trip.id)" class="text-[var(--text-sub)] hover:text-[var(--theme-main)] text-[10px] p-1 bg-[var(--bg-card)]/80 rounded transition">âš™ï¸</button>
                                <button type="button" @click.stop="confirmDeleteTrip(trip.id)" class="text-[var(--text-sub)] hover:text-[var(--danger)] p-1 bg-[var(--bg-card)]/80 rounded transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5"><path d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-[var(--theme-light)]">
                    <button @click="createNewTrip" class="w-full bg-[var(--theme-main)] text-white py-3 rounded-xl font-bold shadow-md hover:bg-[var(--theme-accent)] transition flex justify-center gap-2 text-sm">
                        <span>+</span> å»ºç«‹æ–°æ—…ç¨‹
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Header -->
    <div class="sticky top-0 z-30 bg-[var(--bg-body)]/95 backdrop-blur-sm border-b border-[var(--theme-light)] p-4 transition-colors">
        <button @click="showSidebar = true" class="absolute left-4 top-5 text-[var(--theme-main)] hover:text-[var(--theme-accent)] transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
        </button>

        <div class="flex items-center justify-center mb-4 pl-8 pr-8">
            <input v-model="tripName" @change="saveData" class="text-center w-full text-xl font-bold text-[var(--theme-main)] bg-transparent border-b-2 border-transparent focus:border-[var(--theme-accent)] transition placeholder-[var(--text-sub)] py-1 tracking-widest" placeholder="æ—…ã®è¨ˆç”»...">
        </div>
        
        <div class="flex justify-center mb-3">
            <div class="bg-[var(--theme-light)]/30 p-1.5 rounded-full flex w-full max-w-[360px] shadow-inner gap-1 overflow-x-auto scrollbar-hide">
                <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                    :class="currentTab === tab.id ? 'bg-[var(--bg-card)] text-[var(--theme-main)] shadow-sm font-bold' : 'text-[var(--text-sub)] hover:bg-white/50'" 
                    class="flex-1 py-1.5 px-2 rounded-full text-xs transition-all duration-300 tracking-wide whitespace-nowrap">{{ tab.name }}</button>
            </div>
        </div>

        <div v-if="currentTab === 'schedule'" class="flex flex-col gap-2 mt-2 px-1">
            <div class="flex items-center justify-end px-1 gap-2">
                <label class="text-[10px] text-[var(--text-sub)]">å‡ºç™¼æ—¥:</label>
                <input type="date" v-model="startDate" @change="saveData" class="text-[10px] bg-transparent text-[var(--theme-main)] font-en outline-none border-b border-[var(--theme-light)]">
            </div>
            <div class="flex items-center gap-2">
                <div class="flex-1 min-w-0">
                    <div class="overflow-x-auto whitespace-nowrap custom-scroll flex gap-2 pb-2 px-1">
                        <div v-for="(day, index) in days" :key="index" class="shrink-0 cursor-pointer" @click="changeDay(index)">
                            <div :class="{'bg-[var(--theme-main)] text-white shadow-md': currentDayIndex === index, 'bg-[var(--bg-card)] text-[var(--text-sub)] border border-[var(--theme-light)]': currentDayIndex !== index}" class="px-3 py-1.5 rounded-lg flex flex-col items-center justify-center transition-all min-w-[70px]">
                                <span class="text-xs font-en font-bold pointer-events-none">Day {{ index + 1 }}</span>
                                <span class="text-[9px] font-en opacity-80 mt-0.5 pointer-events-none">{{ getDateLabel(index) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="addDay" class="shrink-0 w-8 h-8 mb-2 flex items-center justify-center border-2 border-dashed border-[var(--theme-accent)] text-[var(--theme-main)] rounded-lg text-sm hover:bg-[var(--theme-light)] transition bg-white/50">+</button>
            </div>
        </div>
    </div>

    <!-- å…§å®¹å€ -->
    <div class="p-5 min-h-[500px]">
        
        <!-- PAGE 1: è¡Œç¨‹è¡¨ -->
        <div v-if="currentTab === 'schedule'" class="space-y-6 animate-fade">
            <div v-if="weatherData" class="relative z-10 flex items-center justify-center gap-2 text-[var(--theme-main)] text-sm font-bold w-full mx-auto -mt-6 -mb-6 animate-fade-in bg-[var(--theme-light)]/50 backdrop-blur py-0.5 rounded-md">
                <span class="text-xl">{{ weatherData.icon }}</span><span>{{ weatherData.temp }}Â°C</span><span class="text-[var(--text-sub)] font-normal text-xs">{{ weatherData.desc }}</span>
            </div>

            <div class="relative group">
                <div id="google-map" class="bg-[var(--theme-light)] flex items-center justify-center text-[var(--theme-accent)] text-xs tracking-widest">
                    <span v-if="mapError" class="map-error-msg">âš ï¸ åœ°åœ–è¼‰å…¥å¤±æ•—</span>
                    <span v-else>MAP LOADING...</span>
                </div>
                <button @click="updateMapRoute" class="absolute bottom-4 right-4 bg-white/90 text-[var(--theme-main)] px-4 py-1.5 rounded-full shadow-md border border-[var(--theme-light)] text-[10px] font-bold tracking-wide hover:bg-[var(--theme-main)] hover:text-white transition uppercase z-20">Update Route</button>
            </div>

            <div class="flex justify-between items-end border-b border-[var(--theme-light)] pb-2">
                <h2 class="text-sm text-[var(--text-sub)] tracking-widest font-en uppercase font-bold">Day {{ currentDayIndex + 1 }} <span class="text-xs font-normal ml-1">{{ getDateLabel(currentDayIndex) }}</span></h2>
                <button @click="deleteDay" class="text-[10px] text-[var(--text-sub)] hover:text-[var(--danger)] transition">DELETE DAY</button>
            </div>

            <div class="space-y-2">
                <template v-for="(item, index) in (days[currentDayIndex] ? days[currentDayIndex].activities : [])" :key="index">
                    <div class="flex items-stretch gap-0 group relative bg-transparent hover:bg-[var(--bg-card)] rounded-lg transition overflow-hidden">
                        <div class="flex-1 flex items-start gap-2 py-2 pl-2 min-w-0">
                            <div class="flex flex-col items-center justify-start gap-1 w-20 flex-shrink-0 pt-1">
                                <div class="flex items-center justify-center bg-[var(--bg-card)] rounded px-1 py-1 border border-[var(--theme-light)] shadow-sm w-full">
                                    <select :value="getHour(item.time)" @change="updateTime(item, $event.target.value, 'hour')" class="time-select text-base w-7 text-[var(--theme-main)]"><option v-for="h in hourOptions" :value="h">{{ h }}</option></select>
                                    <span class="text-[var(--text-sub)] font-bold mx-0.5">:</span>
                                    <select :value="getMinute(item.time)" @change="updateTime(item, $event.target.value, 'minute')" class="time-select text-base w-7 text-[var(--theme-main)]"><option v-for="m in minuteOptions" :value="m">{{ m }}</option></select>
                                </div>
                                <select v-model="item.type" @change="saveData" class="appearance-none w-full text-[10px] font-bold text-center text-[var(--text-sub)] bg-transparent outline-none cursor-pointer py-1">
                                    <option value="sightseeing">ğŸ“· æ™¯é»</option><option value="transport">ğŸš… äº¤é€š</option><option value="food">ğŸ´ ç¾é£Ÿ</option><option value="accommodation">ğŸ¨ ä½å®¿</option><option value="other">ğŸ“¦ å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="w-[3px] self-stretch rounded-full opacity-60 my-1 flex-shrink-0" :class="getTypeColor(item.type)"></div>
                            <div class="flex-1 space-y-0 pb-0.5 border-b border-[var(--theme-light)] transition min-w-0">
                                <div class="flex items-center gap-1 w-full">
                                    <input v-model="item.place" @change="saveData" @focus="initAutocomplete(index, $event)" placeholder="åœ°é»åç¨±" class="flex-1 text-base font-bold text-[var(--text-main)] bg-transparent outline-none min-w-0 truncate">
                                    <button @click="handleActivityLink(item)" class="transition p-1 flex-shrink-0" :class="item.link ? 'text-[var(--theme-main)]' : 'text-[var(--theme-light)]'">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5" /></svg>
                                    </button>
                                </div>
                                <textarea rows="1" v-model="item.note" @change="saveData" placeholder="å‚™è¨»..." @input="autoGrow($event.target)" class="w-full text-[10px] text-[var(--text-sub)] bg-transparent outline-none resize-y leading-tight custom-scroll min-h-[24px]"></textarea>
                            </div>
                            <div class="flex flex-col gap-1 items-center justify-center self-center pr-1 flex-shrink-0 w-8">
                                <button v-if="item.type !== 'transport'" @click="openGoogleMaps(item.place)" class="text-[var(--link-blue)] p-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg></button>
                                <button @click="deleteActivity(index)" class="text-[var(--theme-light)] hover:text-[var(--danger)] p-1 transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path d="M6 18 18 6M6 6l12 12" /></svg></button>
                            </div>
                        </div>
                        <div class="w-4 border-l border-[var(--theme-light)] flex flex-col justify-center items-center bg-[var(--bg-body)] flex-shrink-0">
                            <button @click.stop="moveActivity(index, -1)" class="h-1/2 w-full flex items-center justify-center text-[var(--theme-accent)]" :disabled="index === 0">â–²</button>
                            <button @click.stop="moveActivity(index, 1)" class="h-1/2 w-full flex items-center justify-center text-[var(--theme-accent)]" :disabled="index === (days[currentDayIndex].activities.length - 1)">â–¼</button>
                        </div>
                    </div>

                    <div v-if="index < days[currentDayIndex].activities.length - 1" class="ml-12 my-0.5 flex flex-col items-start border-l-2 border-dotted border-[var(--theme-light)] pl-4 min-h-[16px] transition-all">
                        <button v-if="!item.transportToNext && !item.showTransportInput" @click="item.showTransportInput = true" class="text-[9px] font-bold text-[var(--theme-accent)] opacity-40 hover:opacity-100 flex items-center gap-1"><span>+</span> æ¥é§</button>
                        <div v-else class="w-full flex items-start gap-2 animate-fade-in pr-4 pb-1">
                            <span class="text-xs grayscale opacity-70 mt-1">ğŸš…</span>
                            <textarea v-model="item.transportToNext" @change="saveData" rows="2" placeholder="äº¤é€šèªªæ˜..." class="flex-1 text-[10px] bg-transparent border-b border-[var(--theme-light)] outline-none focus:border-[var(--theme-accent)] py-1 resize-none"></textarea>
                            <button @click="item.transportToNext = ''; item.showTransportInput = false; saveData()" class="text-[var(--text-sub)] text-[10px] px-1 mt-1">âœ•</button>
                        </div>
                    </div>
                </template>
            </div>

            <div class="mt-8 pt-4 border-t border-[var(--theme-light)] bg-[var(--theme-light)]/10 rounded-xl p-4">
                <div class="flex items-center gap-2 mb-2 text-[10px] font-bold text-[var(--text-sub)] tracking-widest uppercase"><span>ğŸ“‹ Daily Notes</span></div>
                <textarea v-model="days[currentDayIndex].dailyNote" @change="saveData" @input="autoGrow($event.target)" placeholder="ä»Šæ—¥çš„é‡è¦æé†’æˆ–å¿ƒå¾—..." class="w-full text-xs text-[var(--text-main)] bg-transparent outline-none resize-y leading-relaxed min-h-[60px]"></textarea>
            </div>

            <button @click="addActivity" class="w-full py-3 border border-dashed border-[var(--theme-accent)] text-[var(--theme-accent)] rounded-xl text-xs bg-[var(--bg-card)]/50">+ ADD ITEM</button>
        </div>

        <!-- PAGE 2: æ¶ˆè²»ç´€éŒ„ (åŠŸèƒ½æ¢å¾©å®Œæ•´) -->
        <div v-if="currentTab === 'expenses'" class="space-y-6 animate-fade">
            <!-- åŒ¯ç‡èˆ‡åˆ†æ -->
            <div class="space-y-4">
                <div @click="showRates = !showRates" class="section-header"><h3 class="section-title">EXCHANGE RATES</h3><span class="section-arrow" :class="{'rotate-180': !showRates}">â–¼</span></div>
                <div v-show="showRates" class="bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] p-4 grid grid-cols-3 gap-3 animate-fade">
                    <div class="space-y-1 text-center"><label class="text-[10px] font-bold text-[var(--text-sub)]">ğŸ‡¯ğŸ‡µ JPY</label><input type="number" v-model.number="rates.JPY" @change="saveData" class="w-full text-center border-b text-sm py-1 font-en" step="0.001"></div>
                    <div class="space-y-1 text-center"><label class="text-[10px] font-bold text-[var(--text-sub)]">ğŸ‡ºğŸ‡¸ USD</label><input type="number" v-model.number="rates.USD" @change="saveData" class="w-full text-center border-b text-sm py-1 font-en" step="0.1"></div>
                    <div class="space-y-1 text-center"><label class="text-[10px] font-bold text-[var(--text-sub)]">ğŸ‡ªğŸ‡º EUR</label><input type="number" v-model.number="rates.EUR" @change="saveData" class="w-full text-center border-b text-sm py-1 font-en" step="0.1"></div>
                </div>

                <div @click="showAnalysis = !showAnalysis" class="section-header"><h3 class="section-title">SPENDING ANALYSIS</h3><span class="section-arrow" :class="{'rotate-180': !showAnalysis}">â–¼</span></div>
                <div v-show="showAnalysis" class="bg-[var(--bg-card)] p-5 rounded-xl border border-[var(--theme-light)] animate-fade">
                    <div class="flex justify-between items-center mb-3 h-8 gap-2">
                        <select v-model="analysisFilter" class="analysis-select max-w-[35%]"><option value="all">All</option><option v-for="m in members" :key="m" :value="m">{{ m }}</option></select>
                        <select v-model="analysisCurrency" class="analysis-select max-w-[20%] text-right font-en"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="EUR">EUR</option></select>
                    </div>
                    <div class="relative w-full h-32 flex items-center justify-center"><canvas id="expenseChart"></canvas></div>
                    <div class="space-y-2 mt-4">
                        <div v-for="cat in categoryAnalysis" :key="cat.key" class="flex justify-between items-center text-xs">
                            <span class="flex items-center gap-1.5 font-bold"><span class="w-2.5 h-2.5 rounded-full" :style="{backgroundColor: cat.chartColor}"></span>{{ cat.label }}</span>
                            <span class="font-en font-bold">{{ analysisCurrency }} {{ cat.amount }} <span class="text-[10px] text-[var(--text-sub)] font-bold">({{ cat.percent }}%)</span></span>
                        </div>
                    </div>
                </div>

                <div @click="showSettlement = !showSettlement" class="section-header"><h3 class="section-title">SETTLEMENT</h3><span class="section-arrow" :class="{'rotate-180': !showSettlement}">â–¼</span></div>
                <div v-show="showSettlement" class="bg-[var(--theme-light)]/30 p-5 rounded-xl border border-[var(--theme-light)] animate-fade">
                    <div class="flex justify-end mb-3"><select v-model="displayCurrency" class="text-[10px] font-bold bg-transparent outline-none border border-[var(--theme-light)] rounded px-2 py-1"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
                    <div class="space-y-2">
                        <div v-for="(trans, idx) in settlementPlan" :key="idx" class="settle-row">
                            <div class="settle-payer">{{ trans.from }}</div><div class="settle-label">éœ€çµ¦</div><div class="settle-receiver">{{ trans.to }}</div><div class="settle-amount">{{ trans.amount }}å…ƒ <button @click="settleDebt(trans)" class="ml-2 bg-[var(--theme-main)] text-white text-[9px] px-2 py-0.5 rounded">çµæ¸…</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆå“¡ç®¡ç†èˆ‡æ–°å¢ -->
            <div class="space-y-4 pt-4">
                <div @click="showMembers = !showMembers" class="section-header"><h3 class="section-title">MEMBERS</h3><span class="section-arrow" :class="{'rotate-180': !showMembers}">â–¼</span></div>
                <div v-show="showMembers" class="bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] overflow-hidden animate-fade">
                    <div v-for="(member, idx) in members" :key="idx" class="flex justify-between items-center p-3 border-b border-[var(--theme-light)] last:border-0 text-sm">
                        <span>{{ member }}</span>
                        <button @click.stop="removeMember(idx)" class="text-[var(--danger)]">âœ•</button>
                    </div>
                    <div class="flex p-3 bg-[var(--bg-body)] gap-2">
                        <input v-model="newMemberName" placeholder="æ–°æˆå“¡..." class="flex-1 bg-transparent text-sm outline-none"><button @click="addMember" class="text-[var(--theme-main)] text-xs font-bold">ADD</button>
                    </div>
                </div>

                <h3 class="section-title">NEW EXPENSE</h3>
                <div class="bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] p-4 space-y-4 shadow-sm">
                    <div class="flex gap-2">
                        <select v-model="newExpense.category" class="w-1/3 bg-[var(--bg-body)] border border-[var(--theme-light)] text-[10px] font-bold rounded px-2 py-2"><option value="food">ğŸ´ ç¾é£Ÿ</option><option value="transport">ğŸš… äº¤é€š</option><option value="ticket">ğŸ« é–€ç¥¨</option><option value="entertainment">ğŸ¡ å¨›æ¨‚</option><option value="other">ğŸ“¦ å…¶ä»–</option></select>
                        <input v-model="newExpense.title" placeholder="é …ç›®" class="w-2/3 text-xs font-bold border-b border-[var(--theme-light)]">
                    </div>
                    <div class="flex gap-2">
                        <select v-model="newExpense.currency" class="w-1/3 bg-[var(--bg-body)] border border-[var(--theme-light)] text-[10px] font-bold rounded px-2 py-2"><option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option><option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option><option value="USD">ğŸ‡ºğŸ‡¸ USD</option><option value="EUR">ğŸ‡ªğŸ‡º EUR</option></select>
                        <input type="number" v-model.number="newExpense.amount" :readonly="splitMode === 'custom'" class="w-2/3 text-sm rounded px-3 py-2" :class="splitMode === 'custom' ? 'bg-gray-100' : 'bg-[var(--bg-body)] border border-[var(--theme-light)]'" placeholder="é‡‘é¡">
                    </div>
                    <div class="flex items-center gap-2 bg-[var(--bg-body)] rounded px-2 py-1"><span class="text-xs">ä»˜æ¬¾äºº:</span><select v-model="newExpense.payer" class="w-full text-sm bg-transparent"><option v-for="m in members" :value="m">{{ m }}</option></select></div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px]"><span class="text-[var(--text-sub)]">åˆ†æ“”æ–¹å¼:</span><div class="flex gap-2"><button @click="changeSplitMode('equal')" :class="splitMode === 'equal' ? 'underline font-bold' : ''">å¹³å‡</button><button @click="changeSplitMode('custom')" :class="splitMode === 'custom' ? 'underline font-bold' : ''">è‡ªè¨‚</button></div></div>
                        <div v-if="splitMode === 'equal'" class="flex flex-wrap gap-2"><button v-for="m in members" @click="toggleInvolved(m)" :class="newExpense.involved.includes(m) ? 'bg-[var(--theme-accent)] text-white' : 'bg-white border border-[var(--theme-light)] text-[var(--text-sub)]'" class="px-3 py-1 rounded-full text-xs transition-all">{{ m }}</button></div>
                        <div v-if="splitMode === 'custom'" class="space-y-2 bg-[var(--bg-body)] p-3 rounded-lg border border-[var(--theme-light)]">
                            <div v-for="m in members" class="flex items-center gap-2 text-xs"><span class="w-16 truncate">{{ m }}</span><input type="number" v-model.number="customSplitAmounts[m]" @input="updateTotalFromCustom" class="flex-1 bg-white border border-[var(--theme-light)] rounded px-2 py-1" placeholder="0"></div>
                        </div>
                    </div>
                    <button @click="addExpense" class="w-full bg-[var(--theme-main)] text-white py-2.5 rounded text-xs font-bold tracking-widest hover:bg-[var(--theme-accent)] transition">SAVE RECORD</button>
                </div>

                <h3 class="section-title">HISTORY</h3>
                <div class="space-y-3">
                    <div v-for="(group, dateKey) in groupedExpenses" :key="dateKey">
                        <div class="text-[10px] font-bold text-[var(--text-sub)] mb-2 border-b border-[var(--theme-light)] pb-1">{{ dateKey }}</div>
                        <div v-for="item in group.items" :key="item.originalIndex" class="bg-[var(--bg-card)] p-3 rounded-lg border border-[var(--theme-light)] mb-2 flex justify-between items-center">
                            <div class="flex gap-3 items-center">
                                <span class="text-xl">{{ getCategoryIcon(item.data.category) }}</span>
                                <div><div class="text-sm font-bold">{{ item.data.title }}</div><div class="text-[10px] text-[var(--text-sub)]">{{ item.data.payer }} ä»˜ Â· {{ item.data.currency }} {{ item.data.amount }}</div></div>
                            </div>
                            <button @click.stop="deleteExpense(item.originalIndex)" class="text-[var(--text-sub)] hover:text-[var(--danger)] p-2">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 3: è³¼ç‰©ç¾é£Ÿ (ä¿ç•™ç·¨è¼¯èˆ‡åˆ†é¡) -->
        <div v-if="currentTab === 'wishlist'" class="space-y-6 animate-fade">
            <h3 class="section-title" style="padding-left:0;">SHOPPING & FOOD</h3>
            <div class="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button @click="wishlistFilterDay = 'all'" :class="wishlistFilterDay === 'all' ? 'bg-[var(--theme-main)] text-white' : 'bg-[var(--bg-card)] text-[var(--text-sub)] border border-[var(--theme-light)]'" class="px-4 py-1.5 rounded-full text-[10px] font-bold whitespace-nowrap">å…¨éƒ¨</button>
                <button v-for="(day, idx) in days" :key="idx" @click="wishlistFilterDay = idx" :class="wishlistFilterDay === idx ? 'bg-[var(--theme-main)] text-white' : 'bg-[var(--bg-card)] text-[var(--text-sub)] border border-[var(--theme-light)]'" class="px-4 py-1.5 rounded-full text-[10px] font-bold whitespace-nowrap">Day {{ idx + 1 }}</button>
            </div>
            <div class="space-y-3">
                <div v-for="(item, idx) in paginatedWishlist" :key="idx" class="bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--theme-light)] relative group">
                    <div class="flex items-start gap-3 pr-16">
                        <input type="checkbox" v-model="item.checked" @change="saveData" class="custom-checkbox flex-shrink-0 mt-1">
                        <div class="flex-1 transition-opacity" :class="{'opacity-40': item.checked}">
                            <div class="flex items-center gap-2 mb-1">
                                <component :is="item.url ? 'a' : 'div'" :href="item.url" target="_blank" class="font-bold text-sm truncate" :class="{'text-[var(--link-blue)] underline': item.url}">{{ item.name }}</component>
                                <span v-if="item.day !== 'all'" class="text-[9px] px-1 bg-[var(--theme-light)] text-[var(--theme-main)] rounded font-bold">D{{ item.day + 1 }}</span>
                            </div>
                            <div v-if="item.note" class="text-xs text-[var(--text-sub)]">{{ item.note }}</div>
                        </div>
                    </div>
                    <div class="absolute top-2 right-2 flex items-center gap-1">
                        <button @click="openWishEditModal(item.originalIndex)" class="text-[var(--text-sub)] p-2 hover:bg-gray-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button>
                        <button @click.stop="deleteWishItem(item.originalIndex)" class="text-[var(--danger)] p-2 hover:bg-red-50 rounded-full">âœ•</button>
                    </div>
                </div>
            </div>
            <div class="bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] p-4 space-y-3 mt-4">
                <div class="flex justify-between items-center"><h4 class="text-xs font-bold">æ–°å¢é …ç›®</h4><select v-model="newWishItem.day" class="text-[10px] font-bold bg-[var(--bg-body)] border border-[var(--theme-light)] rounded px-2 py-1"><option value="all">ä¸æŒ‡å®šæ—¥æœŸ</option><option v-for="(day, idx) in days" :key="idx" :value="idx">Day {{ idx + 1 }}</option></select></div>
                <input v-model="newWishItem.name" placeholder="åç¨±" class="w-full text-sm border-b border-[var(--theme-light)] pb-1 transition bg-transparent">
                <input v-model="newWishItem.note" placeholder="å‚™è¨»" class="w-full text-sm border-b border-[var(--theme-light)] pb-1 transition bg-transparent">
                <button @click="addWishItem" class="w-full bg-[var(--theme-main)] text-white py-2.5 rounded text-xs font-bold tracking-widest hover:bg-[var(--theme-accent)] transition">ADD ITEM</button>
            </div>
        </div>

        <!-- PAGE 4: å¸¸ç”¨é€£çµ (æ¢å¾©å®Œæ•´åŠŸèƒ½) -->
        <div v-if="currentTab === 'links'" class="space-y-6 animate-fade">
            <h3 class="section-title" style="padding-left:0;">CLOUD & LINKS</h3>
            <div class="space-y-3">
                <div v-for="(link, idx) in externalLinks" :key="idx" class="flex items-center gap-3 bg-[var(--bg-card)] p-4 rounded-xl border border-[var(--theme-light)] shadow-sm group">
                    <div class="text-2xl bg-[var(--bg-body)] w-10 h-10 flex items-center justify-center rounded-lg border border-[var(--theme-light)]">ğŸ”—</div>
                    <div class="flex-1 min-w-0">
                        <a :href="link.url" target="_blank" class="text-[var(--text-main)] font-bold text-sm block truncate hover:text-[var(--link-blue)]">{{ link.title }}</a>
                        <div class="text-[10px] text-[var(--text-sub)] truncate">{{ link.url }}</div>
                    </div>
                    <button @click.prevent="deleteLink(idx)" class="text-[var(--text-sub)] hover:text-[var(--danger)] p-2">âœ•</button>
                </div>
            </div>
            <!-- æ¢å¾©ï¼šæ–°å¢é€£çµå€å¡Š -->
            <div class="bg-[var(--bg-card)] rounded-xl border border-[var(--theme-light)] p-4 shadow-sm space-y-3 mt-4">
                <h4 class="text-xs font-bold text-[var(--text-main)]">æ–°å¢é€£çµ</h4>
                <input v-model="newLink.title" placeholder="æ¨™é¡Œ" class="w-full text-sm border-b border-[var(--theme-light)] pb-1 bg-transparent">
                <input v-model="newLink.url" placeholder="ç¶²å€ (https://...)" class="w-full text-sm border-b border-[var(--theme-light)] pb-1 bg-transparent">
                <button @click="addLink" class="w-full bg-[var(--theme-main)] text-white py-2.5 rounded text-xs font-bold tracking-widest hover:bg-[var(--theme-accent)] transition">ADD LINK</button>
            </div>
        </div>

        <!-- PAGE 5: è¡Œææ¸…å–® (ä¿æŒåŸæ¨£) -->
        <div v-if="currentTab === 'packing'" class="space-y-6 animate-fade">
            <div class="bg-[var(--bg-card)] p-4 rounded-xl border border-[var(--theme-light)] shadow-sm">
                 <div class="flex justify-between items-center mb-3"><h3 class="section-title" style="padding-left:0;">PACKING PROGRESS</h3><select v-model="currentPackingMember" class="packing-member-select max-w-[40%]"><option v-for="m in members" :key="m" :value="m">{{ m }}</option></select></div>
                 <div class="flex justify-between items-end mb-1"><span class="text-[10px] font-bold text-[var(--text-main)]">{{ currentPackingMember }} çš„æ¸…å–®</span><span class="text-[10px] font-en font-bold text-[var(--theme-main)]">{{ packingProgress }}%</span></div>
                 <div class="h-2 w-full bg-[var(--theme-light)] rounded-full overflow-hidden"><div class="h-full bg-[var(--theme-accent)] transition-all duration-500" :style="{ width: packingProgress + '%' }"></div></div>
            </div>
            <div class="space-y-2">
                <div v-for="(item, idx) in currentPackingList" :key="idx" class="flex items-center gap-3 bg-[var(--bg-card)] p-3 rounded-xl border border-[var(--theme-light)] group"><input type="checkbox" v-model="item.checked" @change="saveData" class="custom-checkbox flex-shrink-0"><input v-model="item.name" @change="saveData" class="flex-1 bg-transparent outline-none text-sm font-bold text-[var(--text-main)] transition-all" :class="{'opacity-50': item.checked}"><button @click="deletePackingItem(idx)" class="text-[var(--text-sub)] hover:text-[var(--danger)] p-1">âœ•</button></div>
            </div>
            <div class="flex gap-2 mt-4"><input v-model="newPackingItem" @keyup.enter="addPackingItem" placeholder="ç‰©å“..." class="flex-1 bg-[var(--bg-card)] border border-[var(--theme-light)] rounded-lg px-3 py-2.5 text-sm outline-none focus:border-[var(--theme-accent)]"><button @click="addPackingItem" class="bg-[var(--theme-main)] text-white px-4 rounded-lg font-bold shadow-md hover:bg-[var(--theme-accent)] transition text-xs">ADD</button></div>
        </div>
    </div>

    <div class="fixed bottom-0 w-full bg-[var(--bg-body)]/90 backdrop-blur border-t border-[var(--theme-light)] p-2 text-center text-[10px] text-[var(--text-sub)] font-en tracking-widest z-40">{{ statusMessage }}</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCv9tkLUA9T3lYlz6JLf_wuWFAZLR2nRHY&libraries=places"></script>

<script>
    const { createApp } = Vue;
    const firebaseConfig = { apiKey: "AIzaSyACnUlpKnoImSKhnmEDLAwKfuUOXAKijrU", authDomain: "mytrip-cf4ce.firebaseapp.com", databaseURL: "https://mytrip-cf4ce-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "mytrip-cf4ce", storageBucket: "mytrip-cf4ce.firebasestorage.app", messagingSenderId: "336541146264", appId: "1:336541146264:web:484f98b025c151a1e244ed" };
    const hasFirebase = true; 
    let db = null;
    if (hasFirebase) { try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e) {} }

    createApp({
        data() {
            return {
                isLoading: true, showSidebar: false, currentTab: 'schedule', 
                tabs: [{id:'schedule', name:'è¡Œç¨‹è¡¨'}, {id:'expenses', name:'æ¶ˆè²»ç´€éŒ„'}, {id:'wishlist', name:'è³¼ç‰©ç¾é£Ÿ'}, {id:'links', name:'å¸¸ç”¨é€£çµ'}, {id:'packing', name:'è¡Œææ¸…å–®'}],
                tripName: '', statusMessage: 'Connecting...', currentDayIndex: 0, startDate: '',
                days: [{ activities: [{ time: '10:00', place: '', type: 'transport', note: '', transportToNext: '', showTransportInput: false, link: '' }], dailyNote: '' }],
                members: ['æˆ‘', 'æ—…ä¼´'], newMemberName: '',
                showRates: false, displayCurrency: 'TWD', analysisCurrency: 'TWD',
                analysisFilter: 'all', rates: { TWD: 1, JPY: 0.22, USD: 32.5, EUR: 35.0 },
                expenses: [], splitMode: 'equal', customSplitAmounts: {},
                newExpense: { title: '', amount: '', payer: 'æˆ‘', currency: 'TWD', involved: ['æˆ‘', 'æ—…ä¼´'], category: 'food', splitType: 'equal', customData: {} },
                externalLinks: [], newLink: { title: '', url: '' },
                wishlist: [], newWishItem: { name: '', url: '', address: '', note: '', day: 'all' },
                wishlistFilterDay: 'all', wishlistPage: 1, wishlistItemsPerPage: 10,
                showWishEditModal: false, editingWishIdx: null, editWishTemp: { name: '', day: 'all', note: '', url: '', address: '' },
                showAnalysis: true, showSettlement: true, showMembers: true, collapsedDates: {},
                packingList: {}, newPackingItem: '', currentPackingMember: '',
                mapError: false, weatherStatus: 'loading', 
                hourOptions: Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0')),
                minuteOptions: Array.from({length: 12}, (_, i) => (i * 5).toString().padStart(2, '0')),
                expandedHistoryIndices: [], allTrips: {}, currentTripId: null,
                showSettingsModal: false, editTemp: { name: '', theme: 'wood' }, pendingTripId: null,
                weatherData: null, chartInstance: null, isMapUpdating: false, localOrder: [],
                themePresets: { wood: { '--bg-body': '#fdfcf8', '--bg-card': '#ffffff', '--theme-main': '#8b5e3c', '--theme-light': '#f0e6dd', '--theme-accent': '#b08d73', '--text-main': '#4a4036', '--text-sub': '#968c83', '--danger': '#d68c8c', '--link-blue': '#7ca5b8' }, sakura: { '--bg-body': '#fff5f7', '--bg-card': '#ffffff', '--theme-main': '#d65d7a', '--theme-light': '#ffe4e8', '--theme-accent': '#f4a6b5', '--text-main': '#5c3a41', '--text-sub': '#9e7e85', '--danger': '#ff6b6b', '--link-blue': '#7ca5b8' }, ocean: { '--bg-body': '#f0f8ff', '--bg-card': '#ffffff', '--theme-main': '#4a7a8c', '--theme-light': '#dcedf5', '--theme-accent': '#7fb0c2', '--text-main': '#2c3e50', '--text-sub': '#7f8c8d', '--danger': '#e74c3c', '--link-blue': '#7ca5b8' }, matcha: { '--bg-body': '#f6f9f6', '--bg-card': '#ffffff', '--theme-main': '#5e7e5e', '--theme-light': '#ddeedd', '--theme-accent': '#8daf8d', '--text-main': '#2d382d', '--text-sub': '#889988', '--danger': '#c45c5c', '--link-blue': '#7ca5b8' }, night: { '--bg-body': '#1a1a1a', '--bg-card': '#2a2a2a', '--theme-main': '#e0e0e0', '--theme-light': '#444444', '--theme-accent': '#666666', '--text-main': '#e0e0e0', '--text-sub': '#999999', '--danger': '#ff5555', '--link-blue': '#7ca5b8' } }
            }
        },
        watch: {
            currentTab(newVal) { if (newVal === 'schedule') { this.$nextTick(() => { this.retryInitMap(0); }); } else if (newVal === 'expenses') { this.$nextTick(() => { this.renderChart(); }); } },
            analysisCurrency() { if(this.currentTab === 'expenses') this.renderChart(); },
            analysisFilter() { if(this.currentTab === 'expenses') this.renderChart(); },
            expenses: { handler() { if(this.currentTab === 'expenses') this.renderChart(); }, deep: true },
            members(newVal) { if (newVal.length > 0 && !newVal.includes(this.currentPackingMember)) { this.currentPackingMember = newVal[0]; } newVal.forEach(m => { if (!this.packingList[m]) this.packingList[m] = []; }); }
        },
        computed: {
            filteredWishlist() {
                let list = this.wishlist.map((item, index) => ({ ...item, originalIndex: index }));
                if (this.wishlistFilterDay !== 'all') { list = list.filter(item => item.day === this.wishlistFilterDay); }
                return list;
            },
            paginatedWishlist() { const start = (this.wishlistPage - 1) * this.wishlistItemsPerPage; return this.filteredWishlist.slice(start, start + this.wishlistItemsPerPage); },
            totalWishlistPages() { return Math.ceil(this.filteredWishlist.length / this.wishlistItemsPerPage) || 1; },
            currentPackingList() { return this.packingList[this.currentPackingMember] || []; },
            packingProgress() { const list = this.currentPackingList; if (list.length === 0) return 0; const checkedCount = list.filter(i => i.checked).length; return Math.round((checkedCount / list.length) * 100); },
            currentThemeStyles() { const trip = this.allTrips[this.currentTripId]; const themeKey = (trip && trip.theme) ? trip.theme : 'wood'; return this.themePresets[themeKey] || this.themePresets['wood']; },
            sortedTrips() { if (!this.allTrips) return []; let trips = Object.keys(this.allTrips).map(key => ({ id: key, ...this.allTrips[key] })); trips.sort((a, b) => { const indexA = this.localOrder.indexOf(a.id); const indexB = this.localOrder.indexOf(b.id); const valA = indexA === -1 ? -999 : indexA; const valB = indexB === -1 ? -999 : indexB; return valA - valB; }); return trips; },
            categoryAnalysis() { return this.calcAnalysis(); },
            groupedExpenses() { const groups = {}; this.expenses.forEach((exp, index) => { const dateKey = exp.date ? exp.date.split(' ')[0] : 'å…¶ä»–'; if (!groups[dateKey]) { groups[dateKey] = { items: [] }; } groups[dateKey].items.push({ data: exp, originalIndex: index }); }); return groups; },
            settlementPlan() { if (!this.members.length) return []; let balances = {}; this.members.forEach(m => balances[m] = 0); this.expenses.forEach(exp => { let rate = this.rates[exp.currency] || 1; let valInTWD = exp.amount * rate; if (balances[exp.payer] !== undefined) balances[exp.payer] += valInTWD; if (exp.splitType === 'custom' && exp.customData) { for (let m in exp.customData) { if (this.members.includes(m)) { let share = (exp.customData[m] || 0) * rate; if (balances[m] !== undefined) balances[m] -= share; } } } else { let involved = (exp.involved || []).filter(m => this.members.includes(m)); if (involved.length > 0) { let split = valInTWD / involved.length; involved.forEach(m => { if (balances[m] !== undefined) balances[m] -= split; }); } } }); let debtors = []; let creditors = []; for (const [name, amount] of Object.entries(balances)) { if (amount < -1) debtors.push({ name, amount: amount }); else if (amount > 1) creditors.push({ name, amount: amount }); } debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount); let transactions = []; let i = 0, j = 0; while (i < debtors.length && j < creditors.length) { let debtor = debtors[i], creditor = creditors[j]; let amount = Math.min(Math.abs(debtor.amount), creditor.amount); let targetRate = this.rates[this.displayCurrency] || 1; transactions.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount / targetRate) }); debtor.amount += amount; creditor.amount -= amount; if (Math.abs(debtor.amount) < 1) i++; if (creditor.amount < 1) j++; } return transactions; }
        },
        mounted() { this.loadTripList(); window.gm_authFailure = () => { this.mapError = true; }; setTimeout(() => { if(this.isLoading) this.isLoading = false; }, 5000); },
        methods: {
            autoGrow(element) { element.style.height = "auto"; element.style.height = (element.scrollHeight) + "px"; },
            prevPage() { if (this.wishlistPage > 1) this.wishlistPage--; },
            nextPage() { if (this.wishlistPage < this.totalWishlistPages) this.wishlistPage++; },
            loadDefaultPackingItems() { const defaults = ["è­·ç…§", "å¤–å¹£", "æ›æ´—è¡£ç‰©", "ç¶²å¡"]; if (!this.packingList[this.currentPackingMember]) this.packingList[this.currentPackingMember] = []; defaults.forEach(name => { if (!this.packingList[this.currentPackingMember].some(i => i.name === name)) { this.packingList[this.currentPackingMember].push({ name, checked: false }); } }); this.saveData(); },
            addPackingItem() { if(this.newPackingItem.trim()) { if (!this.packingList[this.currentPackingMember]) this.packingList[this.currentPackingMember] = []; this.packingList[this.currentPackingMember].push({ name: this.newPackingItem.trim(), checked: false }); this.newPackingItem = ''; this.saveData(); } },
            deletePackingItem(idx) { if(confirm("åˆªé™¤ç‰©å“ï¼Ÿ")) { this.packingList[this.currentPackingMember].splice(idx, 1); this.saveData(); } },
            addWishItem() { if (this.newWishItem.name) { this.wishlist.push({ ...this.newWishItem, checked: false }); this.newWishItem = { name: '', url: '', address: '', note: '', day: 'all' }; this.saveData(); } },
            deleteWishItem(originalIdx) { if(confirm("åˆªé™¤é …ç›®ï¼Ÿ")) { this.wishlist.splice(originalIdx, 1); this.saveData(); } },
            openWishEditModal(idx) { this.editingWishIdx = idx; this.editWishTemp = { ...this.wishlist[idx] }; this.showWishEditModal = true; },
            saveWishItemEdit() { if(this.editingWishIdx !== null) { this.wishlist[this.editingWishIdx] = { ...this.editWishTemp }; this.showWishEditModal = false; this.saveData(); } },
            addLink() { if(this.newLink.title && this.newLink.url) { this.externalLinks.push({ ...this.newLink }); this.newLink = { title: '', url: '' }; this.saveData(); } },
            deleteLink(idx) { if(confirm("åˆªé™¤é€£çµï¼Ÿ")) { this.externalLinks.splice(idx, 1); this.saveData(); } },
            syncLocalOrder() { const savedOrder = JSON.parse(localStorage.getItem('myTripOrder') || '[]'); const currentIds = Object.keys(this.allTrips); let newOrder = savedOrder.filter(id => currentIds.includes(id)); const newIds = currentIds.filter(id => !newOrder.includes(id)); newOrder = [...newIds, ...newOrder]; this.localOrder = newOrder; localStorage.setItem('myTripOrder', JSON.stringify(this.localOrder)); },
            applyTheme(themeKey) { const styles = this.themePresets[themeKey] || this.themePresets['wood']; for (const [key, value] of Object.entries(styles)) { document.documentElement.style.setProperty(key, value); } },
            previewTheme(key) { this.editTemp.theme = key; this.applyTheme(key); },
            cancelSettings() { this.showSettingsModal = false; const originalTheme = this.allTrips[this.currentTripId]?.theme || 'wood'; this.applyTheme(originalTheme); },
            confirmDeleteTrip(tripId) { if(confirm("ç¢ºå®šåˆªé™¤æ—…ç¨‹ï¼Ÿ")) { this.deleteTripBook(tripId); } },
            deleteActivity(index) { if (confirm("ç¢ºå®šåˆªé™¤è¡Œç¨‹é …ç›®ï¼Ÿ")) { this.days[this.currentDayIndex].activities.splice(index, 1); this.saveData(); this.$nextTick(() => this.updateMapRoute()); } },
            openTripSettings(tripId) { this.pendingTripId = tripId; const trip = this.allTrips[tripId]; this.editTemp = { name: trip.tripName, theme: trip.theme || 'wood' }; this.showSettingsModal = true; },
            saveTripSettings() { if (this.allTrips[this.pendingTripId]) { this.allTrips[this.pendingTripId].tripName = this.editTemp.name; this.allTrips[this.pendingTripId].theme = this.editTemp.theme; if (hasFirebase) { db.ref('trips/' + this.pendingTripId).update({ tripName: this.editTemp.name, theme: this.editTemp.theme }); } this.showSettingsModal = false; this.saveData(); } },
            calcAnalysis() { const map = { 'food': { label: 'ç¾é£Ÿ', chartColor: '#fca5a5' }, 'transport': { label: 'äº¤é€š', chartColor: '#93c5fd' }, 'ticket': { label: 'é–€ç¥¨', chartColor: '#d8b4fe' }, 'entertainment': { label: 'å¨›æ¨‚', chartColor: '#fcd34d' }, 'other': { label: 'å…¶ä»–', chartColor: '#d1d5db' }, 'accommodation': { label: 'ä½å®¿', chartColor: '#86efac' } }; let stats = {}; Object.keys(map).forEach(k => stats[k] = 0); let totalTWD = 0; const targetRate = this.rates[this.analysisCurrency] || 1; this.expenses.forEach(exp => { let rate = this.rates[exp.currency] || 1; let valInTWD = exp.amount * rate; let cat = exp.category || 'other'; let amountToAdd = 0; if (this.analysisFilter === 'all') { amountToAdd = valInTWD; } else { const member = this.analysisFilter; if (exp.splitType === 'custom' && exp.customData) { amountToAdd = (exp.customData[member] || 0) * rate; } else { let involved = (exp.involved || []).filter(m => this.members.includes(m)); if (involved.includes(member)) { amountToAdd = valInTWD / involved.length; } } } stats[cat] += amountToAdd; totalTWD += amountToAdd; }); return Object.keys(stats).map(key => ({ key: key, label: map[key].label, chartColor: map[key].chartColor, amount: Math.round(stats[key] / targetRate), percent: totalTWD > 0 ? Math.round((stats[key] / totalTWD) * 100) : 0 })).filter(item => item.amount > 0).sort((a, b) => b.amount - a.amount); },
            renderChart() { const ctx = document.getElementById('expenseChart'); if (!ctx) return; const data = this.categoryAnalysis; if (this.chartInstance) { this.chartInstance.destroy(); } if (data.length === 0) return; this.chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: data.map(d => d.label), datasets: [{ data: data.map(d => d.amount), backgroundColor: data.map(d => d.chartColor), borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '65%' } }); },
            loadTripList() { if (hasFirebase) { db.ref('trips').on('value', snapshot => { this.allTrips = snapshot.val() || {}; if(Object.keys(this.allTrips).length === 0) { this.createNewTrip(); } else if(!this.currentTripId) { this.$nextTick(() => { if (this.sortedTrips.length > 0) this.openTrip(this.sortedTrips[0].id); }); } }); } else { this.allTrips = JSON.parse(localStorage.getItem('myTripBooks') || '{}'); if(Object.keys(this.allTrips).length === 0) this.createNewTrip(); else this.openTrip(this.sortedTrips[0].id); } },
            createNewTrip() { const newTripId = 'trip_' + Date.now(); const defaultTrip = { tripName: 'æ–°æ—…ç¨‹', theme: 'wood', days: [{ activities: [], dailyNote: '' }], members: ['æˆ‘', 'æ—…ä¼´'], startDate: new Date().toISOString().split('T')[0], wishlist: [], packingList: {}, expenses: [], externalLinks: [] }; if (hasFirebase) db.ref('trips/' + newTripId).set(defaultTrip); else { this.allTrips[newTripId] = defaultTrip; localStorage.setItem('myTripBooks', JSON.stringify(this.allTrips)); } this.openTrip(newTripId); },
            openTrip(tripId) { this.currentTripId = tripId; this.isLoading = true; if (hasFirebase) db.ref('trips/' + tripId).on('value', s => this.handleTripData(s.val())); else this.handleTripData(this.allTrips[tripId]); },
            handleTripData(d) { if (d) { this.tripName = d.tripName || ''; this.days = (d.days || [{ activities: [] }]).map(day => ({ ...day, dailyNote: day.dailyNote || '', activities: (day.activities || []).map(act => ({ ...act, transportToNext: act.transportToNext || '', showTransportInput: !!act.transportToNext, link: act.link || '' })) })); this.members = d.members || ['æˆ‘', 'æ—…ä¼´']; this.expenses = d.expenses || []; this.wishlist = d.wishlist || []; this.packingList = d.packingList || {}; this.externalLinks = d.externalLinks || []; this.rates = d.rates || { TWD: 1, JPY: 0.22, USD: 32.5, EUR: 35.0 }; this.startDate = d.startDate || ''; this.applyTheme(d.theme || 'wood'); this.isLoading = false; this.showSidebar = false; this.$nextTick(() => this.retryInitMap(0)); } },
            saveData() { if (!this.currentTripId) return; const data = { tripName: this.tripName, theme: this.allTrips[this.currentTripId]?.theme || 'wood', days: this.days, members: this.members, expenses: this.expenses, wishlist: this.wishlist, packingList: this.packingList, rates: this.rates, externalLinks: this.externalLinks, startDate: this.startDate }; if (hasFirebase) db.ref('trips/' + this.currentTripId).update(data); else { this.allTrips[this.currentTripId] = data; localStorage.setItem('myTripBooks', JSON.stringify(this.allTrips)); } this.statusMessage = 'Saved'; },
            changeSplitMode(mode) { this.splitMode = mode; if(mode === 'custom') { this.customSplitAmounts = {}; this.members.forEach(m => this.customSplitAmounts[m] = 0); this.newExpense.amount = 0; } },
            updateTotalFromCustom() { let sum = 0; for (let key in this.customSplitAmounts) sum += (this.customSplitAmounts[key] || 0); this.newExpense.amount = sum; },
            toggleInvolved(m) { const idx = this.newExpense.involved.indexOf(m); if (idx > -1) this.newExpense.involved.splice(idx, 1); else this.newExpense.involved.push(m); },
            addMember() { if(this.newMemberName.trim()) { this.members.push(this.newMemberName.trim()); this.newMemberName=''; this.saveData(); } },
            removeMember(idx) { if(confirm('ç§»é™¤ï¼Ÿ')) { this.members.splice(idx, 1); this.saveData(); } },
            addExpense() { if(this.newExpense.title && this.newExpense.amount) { const now = new Date(); const record = { ...this.newExpense, splitType: this.splitMode, customData: { ...this.customSplitAmounts }, date: `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}` }; this.expenses.push(record); this.newExpense.title = ''; this.newExpense.amount = 0; this.saveData(); } },
            deleteExpense(idx) { if(confirm("åˆªé™¤ï¼Ÿ")) { this.expenses.splice(idx, 1); this.saveData(); } },
            settleDebt(trans) { if (!confirm(`ç¢ºå®šçµæ¸… ${trans.from} çµ¦ ${trans.to} çš„ ${trans.amount} å…ƒï¼Ÿ`)) return; const now = new Date(); this.expenses.push({ title: `çµæ¸…: ${trans.from} â†’ ${trans.to}`, amount: trans.amount, currency: this.displayCurrency, payer: trans.from, involved: [trans.to], category: 'other', splitType: 'equal', date: `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}` }); this.saveData(); },
            moveActivity(index, direction) { const list = this.days[this.currentDayIndex].activities; if (direction === -1 && index > 0) [list[index], list[index-1]] = [list[index-1], list[index]]; else if (direction === 1 && index < list.length - 1) [list[index], list[index+1]] = [list[index+1], list[index]]; this.saveData(); this.$nextTick(() => this.updateMapRoute()); },
            getDateLabel(index) { if (!this.startDate) return ''; const start = new Date(this.startDate); start.setDate(start.getDate() + index); return `${(start.getMonth() + 1).toString().padStart(2, '0')}/${start.getDate().toString().padStart(2, '0')}`; },
            getCategoryIcon(cat) { const icons = { 'food': 'ğŸ´', 'transport': 'ğŸš…', 'ticket': 'ğŸ«', 'entertainment': 'ğŸ¡', 'other': 'ğŸ“¦' }; return icons[cat] || 'ğŸ“¦'; },
            getTypeColor(type) { switch(type) { case 'food': return 'bg-[#d8a48f]'; case 'transport': return 'bg-[#8ab8a8]'; case 'accommodation': return 'bg-[#9ea6b3]'; default: return 'bg-[#dccbba]'; } },
            retryInitMap(attempts) { if (attempts > 10) return; if (typeof google !== 'undefined') this.initMap(); else setTimeout(() => this.retryInitMap(attempts + 1), 200); },
            initMap() { if (!document.getElementById("google-map")) return; this.directionsService = new google.maps.DirectionsService(); this.directionsRenderer = new google.maps.DirectionsRenderer({ polylineOptions: { strokeColor: "#8b5e3c", strokeWeight: 4 } }); this.map = new google.maps.Map(document.getElementById("google-map"), { zoom: 12, center: { lat: 35.68, lng: 139.76 }, disableDefaultUI: true, styles: [{ "featureType": "road", "stylers": [{ "saturation": -100 }] }] }); this.directionsRenderer.setMap(this.map); this.updateMapRoute(); },
            async updateMapRoute() { 
                if (!this.directionsService || this.currentTab !== 'schedule' || this.isMapUpdating) return; 
                this.isMapUpdating = true; 
                try {
                    if (this.markers) this.markers.forEach(m => m.setMap(null)); this.markers = [];
                    const activities = (this.days[this.currentDayIndex] || {}).activities || []; 
                    const places = activities.filter(a => a.place && a.place.trim() !== "" && a.type !== 'transport').map(a => a.place);
                    if (places.length === 0) { this.directionsRenderer.setDirections({routes: []}); return; }
                    const geocoder = new google.maps.Geocoder();
                    let validLocations = []; 
                    for (let p of places) {
                        try { const res = await new Promise((resolve, reject) => { geocoder.geocode({'address': p}, (r, s) => s === 'OK' ? resolve(r) : reject(s)); }); if (res[0]) validLocations.push(res[0].geometry.location); } catch (e) {}
                    }
                    if (validLocations.length > 1) {
                        const result = await new Promise((resolve, reject) => { this.directionsService.route({ origin: validLocations[0], destination: validLocations[validLocations.length - 1], waypoints: validLocations.slice(1, -1).map(loc => ({ location: loc, stopover: true })), travelMode: 'DRIVING' }, (res, status) => status === 'OK' ? resolve(res) : reject(status)); });
                        this.directionsRenderer.setDirections(result);
                    } else if (validLocations.length === 1) { this.map.setCenter(validLocations[0]); this.markers.push(new google.maps.Marker({ map: this.map, position: validLocations[0] })); }
                } catch (error) {} finally { this.isMapUpdating = false; }
            },
            getHour(t) { return t ? t.split(':')[0] : '10'; },
            getMinute(t) { return t ? t.split(':')[1] : '00'; },
            updateTime(item, val, type) { let [h, m] = (item.time || '10:00').split(':'); if(type==='hour') h=val; else m=val; item.time=`${h}:${m}`; this.saveData(); },
            openGoogleMaps(p) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p)}`, '_blank'); },
            initAutocomplete(idx, e) { const input = e.target; if (input.dataset.init) return; const ac = new google.maps.places.Autocomplete(input); ac.addListener('place_changed', () => { const p = ac.getPlace(); if (p.name) { this.days[this.currentDayIndex].activities[idx].place = p.name; this.saveData(); this.updateMapRoute(); } }); input.dataset.init = 'true'; },
            handleActivityLink(item) { if (item.link) { if (confirm("é–‹å•Ÿé€£çµï¼Ÿ")) window.open(item.link, '_blank'); else { const newUrl = prompt("ä¿®æ”¹ç¶²å€:", item.link); if (newUrl !== null) { item.link = newUrl.trim(); this.saveData(); } } } else { const url = prompt("è¼¸å…¥ç¶²å€:", "https://"); if (url && url !== "https://") { item.link = url.trim(); this.saveData(); } } },
            changeDay(idx) { this.currentDayIndex = idx; this.$nextTick(() => this.updateMapRoute()); },
            addDay() { this.days.push({ activities: [], dailyNote: '' }); this.changeDay(this.days.length - 1); this.saveData(); },
            deleteDay() { if(confirm('åˆªé™¤æ­¤æ—¥ï¼Ÿ')) { this.days.splice(this.currentDayIndex, 1); if(this.days.length === 0) this.days.push({activities:[], dailyNote: ''}); this.currentDayIndex = Math.max(0, this.currentDayIndex - 1); this.saveData(); } }
        }
    }).mount('#app');
</script>
</body>
</html>